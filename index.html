<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°íƒ€ ë¿Œì…”ë¿Œì…”</title>
    <style>
        /* ========================================================= */
        /* === í†µí•©ëœ CSS ë³€ìˆ˜ (ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ ê¸°ì¤€ í…Œë§ˆ + ì§€íŒ ê³ ìœ  ë³€ìˆ˜) === */
        /* ========================================================= */
        :root {
            /* ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ ê¸°ë³¸ í…Œë§ˆ ë³€ìˆ˜ (Dark Mode Default) */
            --bg-primary: #020e16; 
            --bg-panel: #1a1a3a; 
            --text-main: #f0f0f0; 
            --text-secondary: #aaaaaa; 
            --color-panel-border: #3c3c6e; 
            --color-input-bg: #2a2a4a; 
            --color-accent: #87ceeb; /* Blue í…Œë§ˆ ê¸°ë³¸ê°’ */
            --color-highlight: #87ceeb; 
            --color-indicator: #dc3545; 

            /* ì§€íŒ ì‹œê°í™” ê³ ìœ  ë³€ìˆ˜ */
            --color-simple-other: #bbbbbb; 
            --color-divider: #cccccc; 
            
            --color-root-highlight: #ff0055; 
            --color-root-border: #ffffff;
            
            /* [ìˆ˜ì • 4] í†µí•© ì§€íŒ ë²”ë¡€/ë¶„í• ì„ ìœ„í•œ ìƒ‰ìƒ (5ê°€ì§€) */
            --color-p1: #FFB347; /* Pastel Orange */
            --color-p2: #87CEEB; /* Sky Blue */
            --color-p3: #77DD77; /* Pastel Green */
            --color-p4: #9370DB; /* Medium Purple */
            --color-p5: #DDA0DD; /* Plum (Light Purple) */
            
            --fret-0-width: 40px; 
            --fret-width: 60px; /* ìˆ˜ì • 3: ìŠ¤í¬ë¡¤ ë°©ì§€ë¥¼ ìœ„í•´ í­ ì¦ê°€ (ê¸°ì¡´ 55px) */
            --dot-color: #ccc;
        }

        /* === ìƒ‰ìƒ í…Œë§ˆ ì •ì˜ (ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜) === */
        .theme-blue {
            --color-accent: #87ceeb; 
            --color-highlight: #87ceeb; 
            --color-indicator: #3567dc; 
        }
        .instance-title{ display: none;}
        /* === Light Mode Overrides (ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜) === */
        .light-mode {
            --bg-primary: #f0f0f5; 
            --bg-panel: #ffffff; 
            --text-main: #333333;
            --text-secondary: #666666;
            --color-panel-border: #e0e0e0;
            --color-input-bg: #f8f8f8;
        }

        /* ========================================================= */
        /* === ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ CSS ì‹œì‘ === */
        /* ========================================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }
        .header {
            width: 100%;
            max-width: 960px;
            justify-content: flex-start; 
            align-items: center;
            margin-bottom: 30px;
        }
        h1 { color: var(--text-main); font-size: 2.2em; margin: 0; }
        
        /* ìƒë‹¨ ì»¨í…Œì´ë„ˆ (ì„¤ì •, í…œí¬) */
        .top-container {
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            max-width: 960px;
            width: 100%; 
            justify-content: center; 
            margin-bottom: 20px;
        }
        
        .pattern-panel {
            background-color: var(--bg-panel); border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); width: 100%;
            max-width: 960px; margin: 0 auto 20px auto; transition: background-color 0.3s;
        }
        .panel {
            background-color: var(--bg-panel); border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); flex: 1; min-width: 280px;
            transition: background-color 0.3s;
        }
        h2 {
            color: var(--text-main); font-size: 1.4em; margin-top: 0;
            margin-bottom: 20px; 
            padding-bottom: 10px;
        }
        .setting-item { margin-bottom: 25px; }
        button {
            background-color: var(--color-accent); color: var(--bg-primary); 
            border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer;
            font-size: 1.1em;  transition: background-color 0.3s ease, opacity 0.2s;
            width: 100%; margin-top: 10px;
        }
        button:hover { opacity: 0.9; }
        .metronome-toggle-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding: 10px 0;
            border-top: 1px solid var(--color-panel-border);
            border-bottom: 1px solid var(--color-panel-border);
        }
        .metronome-toggle-label { font-size: 1em; color: var(--text-main); font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--color-panel-border); transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-accent); }
        input:checked + .slider:before { transform: translateX(26px); background-color: var(--bg-primary); }
        .light-mode input:checked + .slider:before { background-color: var(--bg-panel); }
        .swing-control { margin-bottom: 20px; padding-top: 5px; border-top: 1px solid var(--color-panel-border); }
        .swing-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .swing-text-label { font-size: 0.95em; color: var(--text-main); font-weight: bold; }
        .swing-percent { font-size: 1em; color: var(--text-main); font-weight: bold; }
        .swing-slider-container { position: relative; margin-bottom: 15px; }
        .swing-slider-container::after {
            content: ''; position: absolute; top: 50%; left: calc(67% - 3px); 
            transform: translate(-50%, -50%); width: 2px; height: 20px;
            background-color: var(--color-panel-border); pointer-events: none; z-index: 10;
        }
        .swing-slider-labels {
            display: flex; justify-content: space-between; font-size: 0.85em;
            color: var(--text-secondary); margin-top: -10px; margin-bottom: 15px;
        }
        .swing-buttons {
            display: flex; gap: 5px; background-color: var(--color-input-bg);
            border-radius: 6px; padding: 5px; margin-bottom: 15px;
        }
        .swing-btn {
            flex-grow: 1; padding: 8px 0; background-color: transparent;
            color: var(--text-secondary); font-size: 0.9em; font-weight: normal;
            border: none; transition: background-color 0.2s, color 0.2s; margin: 0; border-radius: 4px;
        }
        .swing-btn.active {
            background-color: var(--color-accent); color: var(--bg-primary);
            font-weight: bold; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .bpm-controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 10px; }
        .bpm-input-group { display: flex; align-items: center; gap: 0; width: 100%; border-radius: 6px; overflow: hidden; }
        .bpm-input-group button {
            width: 50px; padding: 10px 0; font-size: 1.5em; font-weight: normal;
            margin: 0; flex-shrink: 0; background-color: var(--bg-panel); 
            color: var(--text-main); border: none; transition: background-color 0.2s;
        }
        .bpm-input-group button:hover { background-color: var(--color-panel-border); }
        .bpm-input-group input {
            flex-grow: 1; text-align: center; font-size: 1.4em; font-weight: bold;
            padding: 8px 5px; margin: 0; border-radius: 0; background-color: var(--bg-panel);
            color: var(--text-main); border: none; min-width: 60px; box-sizing: border-box; 
        }
        #rhythm-tap-tempo-btn { margin-top: 0; background-color: var(--color-accent); color: var(--bg-primary); }
        label { display: block; margin-bottom: 8px; font-size: 0.95em; color: var(--text-secondary); }
        .meter-select, .theme-selector, .mode-selector {
            width: 100%; padding: 10px 10px; border-radius: 6px;
            border: 1px solid var(--color-panel-border); background-color: var(--color-input-bg);
            color: var(--text-main); font-size: 1em; text-align: left;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-repeat: no-repeat; background-position: right 10px top 50%;
            background-size: 10px; padding-right: 25px;
        }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; height: 6px;
            background: var(--color-panel-border); border-radius: 3px;
            outline: none; opacity: 1; transition: opacity .2s; margin: 10px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            border-radius: 50%; background: var(--color-accent); cursor: pointer;
        }
        .slider-text-labels {
            display: flex; justify-content: space-between; font-size: 0.85em;
            color: var(--text-secondary); margin-top: 5px;
        }
        .play-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .play-buttons button { flex: 1; margin-top: 0; }
        .pattern-display {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px;
            margin: 20px; align-items: flex-end;
            -webkit-overflow-scrolling: touch;
        }
        .beat-group {
            display: flex; flex-direction: column; align-items: center;
            position: relative; flex-shrink: 0; padding: 5px; 
        }
        .subdivision-group { display: flex; gap: 4px; margin-top: 10px; }
        .sub-beat {
            width: 18px; height: 18px; border-radius: 4px;
            background-color: var(--color-panel-border); cursor: pointer;
            transition: background-color 0.2s, width 0.1s, height 0.1s, border-radius 0.1s;
        }
        .sub-beat.active { background-color: var(--color-accent); }
        .sub-beat.sub-beat-3 { width: 12px; height: 12px; border-radius: 50%; background-color: var(--text-secondary); }
        .sub-beat.sub-beat-3.active { background-color: var(--color-indicator); }
        .sub-beat.current-16th { outline: 3px solid var(--color-indicator); outline-offset: 1px; }
        .sub-beat.downbeat-16th { width: 22px; height: 22px; border-radius: 6px; }
        .sub-beat.downbeat-16th.sub-beat-3 { width: 16px; height: 16px; border-radius: 50%; }
        .beat-marker {
            width: 100%; text-align: center; font-size: 0.9em;
            color: var(--text-secondary); margin-bottom: 5px; font-weight: bold;
            display:  none;
        }

        /* ========================================================= */
        /* === ê¸°íƒ€ ì§€íŒ ì‹œê°í™” CSS === */
        /* ========================================================= */
        
        #fretboard-collection {
            width: 100%; max-width: 1500px;
            flex-direction: column; gap: 30px; 
        }

        #combined-result-section {
            width: 100%; max-width: 1500px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 3px dashed var(--color-divider);
        }
        
        .fretboard-instance {
            background-color: var(--bg-panel); border-radius: 12px;
            padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%; position: relative; 
        }
        
        .header-action-buttons {
            display: flex; 
            gap: 8px; 
            position: absolute; 
            top: 15px; 
            right: 15px;
            z-index: 20;
        }
        .instance-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; 
            border-bottom: none; 
            padding-bottom: 0;
        }
        .instance-header h2 { margin: 0; font-size: 1.5em; color: var(--color-accent); }

        .fretboard-title-separator {
            border: 0;
            height: 1px;
            background-color: var(--color-panel-border); 
            margin: 0 0 20px 0;
        }
        
        .remove-fretboard-btn {
            background-color: transparent; 
            color: var(--text-secondary); border: 1px solid var(--color-panel-border); 
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-size: 0.75em; transition: all 0.2s; width: auto; z-index: 20; opacity: 0.8;
            margin-top:0px;
        }

        .fretboard-controls-panel { 
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            max-height: 1200px; overflow: hidden; opacity: 1; padding-top: 10px;
        }
        .fretboard-instance.compact-mode .fretboard-controls-panel {
            max-height: 0; opacity: 0; margin-bottom: 0; padding: 0;
        }
        
        .toggle-compact-btn {
            background-color: var(--color-input-bg); 
            color: var(--text-secondary); 
            border: 1px solid var(--color-panel-border); 
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-size: 0.75em; transition: all 0.2s; width: auto; opacity: 0.8;
            margin-top: 0; 
        }

        .fretboard-instance.compact-mode .toggle-compact-btn {
            background-color: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
            font-weight: bold;
            opacity: 1;
        }
        .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        
        .button-group button {
            background-color: #f8f9fa; 
            color: var(--text-main);
            border: 1px solid var(--color-panel-border); 
            padding: 8px 15px;
            font-size: 0.9em; font-weight: normal; margin-top: 0; width: auto; 
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .button-group button:hover { opacity: 0.9; }
        .button-group button.active {
            background-color: var(--color-accent); 
            color: white;
            border-color: var(--color-accent); 
            font-weight: normal; 
        }
        
        .color-mode-buttons button,
        .mode-type-buttons button {
            background-color: #f8f9fa;
            color: var(--text-main);
            border-color: var(--color-panel-border);
        }
        .color-mode-buttons button.active,
        .mode-type-buttons button.active {
             background-color: var(--color-accent);
             color: white;
             border-color: var(--color-accent);
        }

        .note-select-btn {
            background-color: #ffffff; color: var(--text-main);
            border: 2px solid var(--color-panel-border); min-width: 50px;
        }
        .note-select-btn.active { font-weight: bold; }

        .fretboard-display {
            width: 100%; overflow-x: hidden; 
            border: 2px solid #555; 
            border-radius: 4px; position: relative; height: 320px; 
            display: flex; flex-direction: column; 
        }
        .fretboard-row { display: flex; width: fit-content; position: relative; height: calc(100% / 8); }
        .number-row, .marker-row {
            height: calc(100% / 8); 
            min-height: 30px; 
            align-items: center; 
            font-size: 0.9em; 
            color: var(--text-secondary);
        }
        .number-row { border-top: none; border-bottom: 1px solid #000000;} 
        .marker-row { height: calc(100% / 8); min-height: 40px; }
        .string-row { border-bottom: 1px solid #000000; align-items: center; height: calc(100% / 8); }
        .string-row:last-child { border-bottom: none; }
        
        .fret-0-cell { 
            position: relative; height: 100%; flex-basis: var(--fret-0-width); 
            min-width: var(--fret-0-width); display: flex; justify-content: center;
            align-items: center; box-sizing: border-box; border-right: 3px solid #333; 
        }
        .fret-cell {
            position: relative; height: 100%; flex-basis: var(--fret-width); 
            min-width: var(--fret-width); display: flex; justify-content: center;
            align-items: center; box-sizing: border-box; border-right: 2px solid #333; 
        }
        .fretboard-row .fret-cell:nth-child(13) { border-right: 3px solid #333; }
        .fret-marker-dot {
            background: var(--dot-color); width: 8px; height: 8px;
            border-radius: 50%; z-index: 5; position: relative; 
        }
        .marker-cell.double-marker { flex-direction: column; gap: 2px; }
        
        .note-dot {
            width: 30px; height: 30px; border-radius: 50%; position: relative; 
            z-index: 10; display: flex; justify-content: center; align-items: center;
            color: black; font-weight: normal; font-size: 0.9em; cursor: default;
        }
        
        .note-dot.root {
            background-color: var(--color-highlight); 
            border: 2px solid #3567dc; 
            color: white; 
            z-index: 20;
        }
        .note-dot.simple-other {
            background-color: var(--color-simple-other); 
            border: none; 
            color: var(--text-main); 
            font-weight: normal;
        }
        .note-dot.free-note { border: 1px solid var(--text-main); }
        
        .pattern-info {
            margin-top: 15px; margin-bottom: 20px; padding: 10px; 
            border: 1px solid var(--color-panel-border); border-radius: 8px; 
            background-color: var(--color-input-bg); color: var(--text-main);
        }
        .pattern-info strong { color: var(--color-accent); }
        .pattern-info span { font-family: sans-serif; font-size: 1.0em; margin-left: 10px; }
        
        .bottom-controls {
            margin-top: 15px; 
            display: flex; 
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }
        .bottom-controls button {
             padding: 8px 15px; border-radius: 6px; cursor: pointer;
             font-size: 0.9em; margin-top: 0; width: auto;
        }
        .clear-btn { background-color: #f0f0f0; border: 1px solid var(--color-divider); color: var(--text-main); }
        .toggle-compact-btn {
            background-color: #ffc107; color: #333; border: none;
        }

        .fretboard-section-header {
            margin-top: 50px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .add-fretboard-buttons {
            display: flex; gap: 15px; margin-top: 20px; margin-bottom: 20px;
            max-width: 1300px; width: 100%;
            justify-content: center; 
        }
        .add-fretboard-buttons button {
            padding: 15px 30px; font-size: 1.2em; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
            margin-top: 0; width: auto;
        }
        #fretboard-add-full-btn { background-color: var(--color-accent); color: white; }
        #fretboard-add-full-btn:hover { opacity: 0.9; }

        /* ========================================================= */
        /* === RESPONSIVE DESIGN (ë°˜ì‘í˜• ì¶”ê°€ ë° ë ˆì´ì•„ì›ƒ ìˆ˜ì •) === */
        /* ========================================================= */
        
        @media (max-width: 768px) {
            /* 1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ì—¬ë°± ìµœì í™” */
            body { padding: 10px; }
            .header { margin-bottom: 20px; }
            h1 { font-size: 1.6em; }

            /* [ìˆ˜ì • 5] ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ ìˆ˜ì§ ì •ë ¬ ê°•ì œ (í•œ ì¤„ ë°°ì¹˜) */
            .top-container {
                flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
                gap: 15px; /* íŒ¨ë„ ì‚¬ì´ ê°„ê²© ì¶•ì†Œ */
                align-items: stretch;
            }
            
            /* íŒ¨ë„ë“¤ì´ ì‘ì€ í™”ë©´ì—ì„œ ê½‰ ì°¨ê²Œ, ì—¬ë°± ì¤„ì´ê¸° */
            .panel, .pattern-panel, .fretboard-instance {
                width: 100%;
                min-width: 0;
                padding: 15px; /* ë‚´ë¶€ ì—¬ë°± ì¶•ì†Œ (ê¸°ì¡´ 25px -> 15px) */
                box-sizing: border-box;
                margin-bottom: 0; /* top-containerì˜ gapìœ¼ë¡œ ì œì–´ */
            }

            /* [ìˆ˜ì • 5] í°íŠ¸ í¬ê¸° ë‹¤ì´ì–´íŠ¸ (ëª¨ë°”ì¼ ìµœì í™”) */
            h2 { font-size: 1.25em; margin-bottom: 15px; } /* ì œëª© í¬ê¸° ì¶•ì†Œ */
            
            button {
                font-size: 1em; /* ë²„íŠ¼ ê¸€ì í¬ê¸° ì¶•ì†Œ */
                padding: 10px 15px; /* ë²„íŠ¼ íŒ¨ë”© ì¶•ì†Œ */
            }
            
            .bpm-input-group input {
                font-size: 1.2em; /* BPM ìˆ«ì í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            }
            
            .metronome-toggle-label, .swing-text-label, .swing-percent {
                font-size: 0.9em;
            }
            
            label { font-size: 0.9em; }
            .meter-select { font-size: 0.95em; padding: 8px; }

            /* 2. ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ ì„¸ë¶€ ë°˜ì‘í˜• */
            .pattern-display {
                margin: 10px 0;
                padding-bottom: 5px;
            }
            .sub-beat {
                width: 16px; height: 16px; /* í„°ì¹˜ íƒ€ê²Ÿ ìœ ì§€ */
            }
            
            /* 3. ê¸°íƒ€ ì§€íŒ ë°˜ì‘í˜• (ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©) */
            .fretboard-display {
                overflow-x: auto !important; 
                -webkit-overflow-scrolling: touch; 
            }
            
            /* í—¤ë”ì˜ ë²„íŠ¼ë“¤ì´ íƒ€ì´í‹€ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì • */
            .fretboard-instance {
                display: flex;
                flex-direction: column;
            }
            
            .instance-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-top: 35px; /* ìƒë‹¨ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            }
            .instance-header h2 { font-size: 1.3em; }
            
            .header-action-buttons {
                top: 15px;
                right: 15px;
                width: auto;
            }
            .header-action-buttons button {
                font-size: 0.8em;
                padding: 5px 10px;
            }

            .button-group button {
                padding: 8px 10px;
                font-size: 0.85em;
                flex-grow: 1; /* ë²„íŠ¼ë“¤ì´ ê½‰ ì°¨ê²Œ */
                justify-content: center;
                display: flex;
            }
            
            .root-note-buttons .root-btn {
                min-width: 35px;
                flex-grow: 0;
            }

            .slider-text-labels span { font-size: 0.75em; }
        }

        /* ì•„ì´í° ë¯¸ë‹ˆ ë“± ì´ˆì†Œí˜• í™”ë©´ (375px ì´í•˜) ëŒ€ì‘ */
        @media (max-width: 380px) {
            h1 { font-size: 1.4em; }
            .header-action-buttons button {
                padding: 4px 6px;
                font-size: 0.7em;
            }
            .panel { padding: 12px; }
        }

    </style>
</head>
<body>
    
    <div class="header">
        <h1 style="text-align: center;">ê¸°íƒ€ ë¿Œì‹œê¸°</h1>
    </div>

    <div class="top-container">
        <div class="panel">
            <h2>ë¦¬ë“¬ ìƒì„± ì„¤ì •</h2>
            <div class="setting-item">
                <label for="rhythm-time-signature-select">ë°•ì (Time Signature)</label>
                <select id="rhythm-time-signature-select" class="meter-select">
                    <option value="4/4">4/4 ë°•ì</option>
                    <option value="3/4">3/4 ë°•ì</option>
                    <option value="2/4">2/4 ë°•ì</option>
                    <option value="6/8">6/8 ë°•ì</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="rhythm-syncopation-range">ë‹¹ê¹€ìŒ(Syncopation) ë ˆë²¨: <span id="rhythm-syncopation-value">5</span></label>
                <input type="range" id="rhythm-syncopation-range" min="0" max="10" value="5">
                <div class="slider-text-labels">
                    <span>ì•½í•¨ (ì •ë°• ìœ„ì£¼)</span>
                    <span>ê°•í•¨ (ì—‡ë°• ìœ„ì£¼)</span>
                </div>
            </div>
            <div class="setting-item">
                <label for="rhythm-difficulty-range">ë‚œì´ë„ (16ë¶„ ìŒí‘œ ë¹ˆë„): <span id="rhythm-difficulty-value">5</span></label>
                <input type="range" id="rhythm-difficulty-range" min="0" max="10" value="5">
                <div class="slider-text-labels">
                    <span>ì‰¬ì›€ (ë‹¨ìˆœ)</span>
                    <span>ì–´ë ¤ì›€ (ë³µì¡)</span>
                </div>
            </div>
            <button id="rhythm-generate-btn">ë¦¬ë“¬ ìƒì„±</button>
        </div>

        <div class="panel">
            <h2>Tempo</h2>
            <div class="rhythm-bpm-controls bpm-controls">
                <div class="bpm-input-group">
                    <button id="rhythm-bpm-decrease">-</button>
                    <input type="number" id="rhythm-bpm-input" value="120" min="40" max="240">
                    <button id="rhythm-bpm-increase">+</button>
                </div>
                <button id="rhythm-tap-tempo-btn">Tap Tempo</button>
            </div>
            <div class="metronome-toggle-container">
                <span class="metronome-toggle-label">ë©”íŠ¸ë¡œë†ˆ ì¼œê¸°</span>
                <label class="switch">
                    <input type="checkbox" id="rhythm-metronome-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="swing-control">
                <div class="swing-label-row">
                    <span class="swing-text-label">Swing Amount</span>
                    <span class="swing-percent" id="rhythm-swing-percent-value">0%</span>
                </div>
                <div class="swing-slider-container">
                    <input type="range" id="rhythm-swing-amount" min="0" max="100" value="0">
                </div>
                <div class="swing-slider-labels">
                    <span>Straight (0%)</span>
                    <span>Triplet (67%)</span>
                    <span>Hard Swing (100%)</span>
                </div>
                <div class="swing-buttons" id="rhythm-swing-mode-buttons">
                    <button class="swing-btn active" data-swing-value="0">Straight</button>
                    <button class="swing-btn" data-swing-value="67">Triplet</button>
                    <button class="swing-btn" data-swing-value="100">Shuffle</button>
                </div>
            </div>
            <div class="play-buttons">
                <button id="rhythm-play-pause-btn">â–¶ Play</button>
            </div>
        </div>
    </div>

    <div class="pattern-panel">
        <h2 style="padding: 20px 20px 0 20px; margin-bottom: 0; border-bottom: none;">ìƒì„±ëœ ë¦¬ë“¬ íŒ¨í„´</h2>
        <div id="rhythm-pattern-display" class="pattern-display">
        </div>
    </div>

    <div class="fretboard-section-header">
        <h1>ê¸°íƒ€ ì§€íŒ ì‹œê°í™” ë„êµ¬</h1>
    </div>

    <div class="add-fretboard-buttons">
        <button id="fretboard-add-full-btn">ì…ë ¥ ì§€íŒ ì¶”ê°€ +</button>
    </div>

    <div id="fretboard-collection">
    </div>

    <div id="combined-result-section" style="display:none;">
        <div class="fretboard-instance">
            <div class="instance-header">
                <h2 style="color: var(--text-main);">ğŸ¸ í†µí•© ê²°ê³¼ ì§€íŒ (Combined Result)</h2>
            </div>
            <div id="combined-legend" class="pattern-info" style="margin-bottom: 20px;">
                <strong>ìƒ‰ìƒ ë²”ë¡€ (Color Legend):</strong> 
                <div id="legend-items" style="display: flex; flex-wrap: wrap; gap: 15px 30px; margin-top: 10px;">
                </div>
            </div>
            <div class="pattern-info">
                <strong>ì„¤ëª…:</strong> <span>ìœ„ì˜ ëª¨ë“  ì…ë ¥ ì§€íŒì´ í•©ì³ì ¸ì„œ ë³´ì…ë‹ˆë‹¤. (ìˆ˜ì§ ë¶„í• ë¡œ ê° ì§€íŒ ìƒ‰ìƒ í‘œì‹œ)</span>
            </div>
            <div id="combined-fretboard-display" class="fretboard-display">
            </div>
        </div>
    </div>

    <template id="fretboard-template">
        <div class="fretboard-instance" id="fretboard-instance-0">
            <div class="header-action-buttons">
                <button class="toggle-compact-btn">Compact</button>
                <button class="remove-fretboard-btn">X ì œê±°</button>
            </div>
            <div class="instance-header">
                <h2 class="instance-title">ğŸ¸ ì…ë ¥ ì§€íŒ #0</h2>
            </div>
            <hr class="fretboard-title-separator">

            <div class="fretboard-controls-panel">
                <div class="setting-item">
                    <label style="font-weight: bold;">íŒ¨í„´ ëª¨ë“œ ì„ íƒ:</label>
                    <div class="button-group mode-type-buttons">
                        <button class="mode-btn active" data-mode="scale">Scale</button>
                        <button class="mode-btn" data-mode="chord">Chord</button>
                        <button class="mode-btn" data-mode="free">Free Note</button>
                    </div>
                </div>

                <div class="control-group scale-controls">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">ê·¼ìŒ(Root Note) ì„ íƒ:</label>
                    <div class="button-group root-note-buttons horizontal-wrap">
                        <button class="root-btn active" data-root="C">C</button>
                        <button class="root-btn" data-root="C#">C#</button>
                        <button class="root-btn" data-root="Db">Db</button>
                        <button class="root-btn" data-root="D">D</button>
                        <button class="root-btn" data-root="D#">D#</button>
                        <button class="root-btn" data-root="Eb">Eb</button>
                        <button class="root-btn" data-root="E">E</button>
                        <button class="root-btn" data-root="F">F</button>
                        <button class="root-btn" data-root="F#">F#</button>
                        <button class="root-btn" data-root="Gb">Gb</button>
                        <button class="root-btn" data-root="G">G</button>
                        <button class="root-btn" data-root="G#">G#</button>
                        <button class="root-btn" data-root="Ab">Ab</button>
                        <button class="root-btn" data-root="A">A</button>
                        <button class="root-btn" data-root="A#">A#</button>
                        <button class="root-btn" data-root="Bb">Bb</button>
                        <button class="root-btn" data-root="B">B</button>
                    </div>
                    
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; margin-top: 15px;">ìŠ¤ì¼€ì¼ ì¢…ë¥˜ ì„ íƒ:</label>
                    <div class="button-group scale-type-buttons horizontal-wrap">
                        <button class="scale-btn active" data-scale="Major">Major</button>
                        <button class="scale-btn" data-scale="Natural Minor">Natural Minor</button>
                        <button class="scale-btn" data-scale="Harmonic Minor">Harmonic Minor</button>
                        <button class="scale-btn" data-scale="Melodic Minor">Melodic Minor</button>
                        <button class="scale-btn" data-scale="Pentatonic Major">Pent. Major</button>
                        <button class="scale-btn" data-scale="Pentatonic Minor">Pent. Minor</button>
                        <button class="scale-btn" data-scale="Blues">Blues</button>
                        <button class="scale-btn" data-scale="Dorian">Dorian</button>
                        <button class="scale-btn" data-scale="Phrygian">Phrygian</button>
                        <button class="scale-btn" data-scale="Lydian">Lydian</button>
                        <button class="scale-btn" data-scale="Mixolydian">Mixolydian</button>
                        <button class="scale-btn" data-scale="Locrian">Locrian</button>
                        <button class="scale-btn" data-scale="Whole Tone">Whole Tone</button>
                        <button class="scale-btn" data-scale="Diminished">Diminished</button>
                        <button class="scale-btn" data-scale="Hungarian Minor">Hungarian Minor</button>
                        <button class="scale-btn" data-scale="Persian">Persian</button>
                    </div>
                </div>

                <div class="control-group chord-controls" style="display:none;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">ê·¼ìŒ(Root Note) ì„ íƒ:</label>
                    <div class="button-group root-note-buttons horizontal-wrap">
                        <button class="root-btn active" data-root="C">C</button>
                        <button class="root-btn" data-root="C#">C#</button>
                        <button class="root-btn" data-root="Db">Db</button>
                        <button class="root-btn" data-root="D">D</button>
                        <button class="root-btn" data-root="D#">D#</button>
                        <button class="root-btn" data-root="Eb">Eb</button>
                        <button class="root-btn" data-root="E">E</button>
                        <button class="root-btn" data-root="F">F</button>
                        <button class="root-btn" data-root="F#">F#</button>
                        <button class="root-btn" data-root="Gb">Gb</button>
                        <button class="root-btn" data-root="G">G</button>
                        <button class="root-btn" data-root="G#">G#</button>
                        <button class="root-btn" data-root="Ab">Ab</button>
                        <button class="root-btn" data-root="A">A</button>
                        <button class="root-btn" data-root="A#">A#</button>
                        <button class="root-btn" data-root="Bb">Bb</button>
                        <button class="root-btn" data-root="B">B</button>
                    </div>
                    
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; margin-top: 15px;">ì½”ë“œ ì¢…ë¥˜ ì„ íƒ:</label>
                    <div class="button-group chord-type-buttons horizontal-wrap">
                        <button class="chord-btn active" data-chord="Major">Major (M)</button>
                        <button class="chord-btn" data-chord="Minor">Minor (m)</button>
                        <button class="chord-btn" data-chord="Dominant 7th">Dominant 7th (7)</button>
                        <button class="chord-btn" data-chord="Major 7th">Major 7th (M7)</button>
                        <button class="chord-btn" data-chord="Minor 7th">Minor 7th (m7)</button>
                        <button class="chord-btn" data-chord="Diminished">Diminished (dim)</button>
                        <button class="chord-btn" data-chord="Augmented">Augmented (aug)</button>
                        <button class="chord-btn" data-chord="Sus4">Sus4 (sus4)</button>
                        <button class="chord-btn" data-chord="Add9">Add9 (add9)</button>
                        <button class="chord-btn" data-chord="Major 9th">Major 9th (M9)</button>
                        <button class="chord-btn" data-chord="Minor 9th">Minor 9th (m9)</button>
                        <button class="chord-btn" data-chord="Dominant 9th">Dominant 9th (9)</button>
                    </div>
                </div>

                <div class="control-group free-note-controls" style="display:none;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">í‘œì‹œí•  ìŒ ì„ íƒ:</label>
                    <div class="button-group free-note-buttons horizontal-wrap">
                        </div>
                    <div class="bottom-controls">
                        <button class="clear-free-notes-btn">ëª¨ë‘ í•´ì œ</button>
                    </div>
                </div>
                
                <hr class="fretboard-title-separator" style="margin-top: 20px;">
                
                <div class="setting-item">
                    <label style="font-weight: bold;">í‘œì‹œ ëª¨ë“œ:</label>
                    <div class="button-group color-mode-buttons">
                        <button class="display-mode-btn active" data-mode="note">ìŒì´ë¦„</button>
                        <button class="display-mode-btn" data-mode="degree">ìŒì •(ë„ìˆ˜)</button>
                    </div>
                </div>
            </div>

            <div class="pattern-info">
                <strong>íŒ¨í„´ ì •ë³´:</strong> <span class="pattern-info-span">C Major Scale</span>
            </div>

            <div class="fretboard-display">
                </div>
        </div>
    </template>

    <script>
        // DOM Elements
        const rhythmPlayPauseBtn = document.getElementById('rhythm-play-pause-btn');
        const rhythmBPMInput = document.getElementById('rhythm-bpm-input');
        const rhythmBPMIncreaseBtn = document.getElementById('rhythm-bpm-increase');
        const rhythmBPMDecreaseBtn = document.getElementById('rhythm-bpm-decrease');
        const rhythmGenerateBtn = document.getElementById('rhythm-generate-btn');
        const rhythmTapTempoBtn = document.getElementById('rhythm-tap-tempo-btn');
        const rhythmMetronomeToggle = document.getElementById('rhythm-metronome-toggle');
        const rhythmTimeSignatureSelect = document.getElementById('rhythm-time-signature-select');
        const rhythmSwingRange = document.getElementById('rhythm-swing-amount');
        const rhythmSwingPercentValue = document.getElementById('rhythm-swing-percent-value');
        const rhythmSwingButtonsContainer = document.getElementById('rhythm-swing-mode-buttons');
        const rhythmPatternDisplay = document.getElementById('rhythm-pattern-display');
        const rhythmSyncopationRange = document.getElementById('rhythm-syncopation-range');
        const rhythmDifficultyRange = document.getElementById('rhythm-difficulty-range');

        const fretboardCollection = document.getElementById('fretboard-collection');
        const fretboardAddFullBtn = document.getElementById('fretboard-add-full-btn');
        const combinedResultDisplay = document.getElementById('combined-fretboard-display');
        const combinedResultSection = document.getElementById('combined-result-section');
        const fretboardTemplate = document.getElementById('fretboard-template');

        // Rhythm Station Variables
        let rhythmBPM = 120;
        let rhythmIsPlaying = false;
        let rhythmCurrentBeat = 0;
        let rhythmNextNoteTime = 0.0;
        let rhythmScheduleAheadTime = 0.1; // seconds
        let rhythmTimerId = null;
        let rhythmAudioContext = null;
        let rhythmAudioContextInitialized = false;
        let rhythmTimeSignature = '4/4';
        let rhythmBeatsPerMeasure = 4;
        let rhythmSubdivision = 4; // 4 = 16th notes, 3 = triplets (8th note triplets)
        let rhythmSyncopationLevel = 5;
        let rhythmDifficultyLevel = 5;
        let rhythmSwingAmount = 0;
        let rhythmPattern = [];
        let rhythmIsMetronomeAlwaysOn = true;
        let rhythmMetronomeOscillator = null;
        let rhythmMetronomeGain = null;
        let rhythmAddHighlightSchedule = [];
        let rhythmRemoveHighlightSchedule = [];
        
        // **[ìˆ˜ì • 2] Tap Tempo ë³€ìˆ˜ ì¶”ê°€**
        let rhythmTapTimes = []; // íƒ­ ì‹œê°„ ê¸°ë¡ì„ ìœ„í•œ ë°°ì—´ ì¶”ê°€
        const rhythmTapTimeMax = 4; // ìµœê·¼ 4ê°œì˜ íƒ­ì„ ê¸°ì¤€ìœ¼ë¡œ í‰ê·  BPM ê³„ì‚°

        function rhythmInitAudio() {
            if (rhythmAudioContextInitialized) return;
            rhythmAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            rhythmMetronomeOscillator = rhythmAudioContext.createOscillator();
            rhythmMetronomeOscillator.type = 'square';
            rhythmMetronomeOscillator.frequency.setValueAtTime(440, 0);
            rhythmMetronomeOscillator.start(0);
            rhythmMetronomeGain = rhythmAudioContext.createGain();
            rhythmMetronomeGain.gain.setValueAtTime(0, 0);
            rhythmMetronomeOscillator.connect(rhythmMetronomeGain);
            rhythmMetronomeGain.connect(rhythmAudioContext.destination);
            rhythmAudioContextInitialized = true;
        }

        function rhythmScheduler() {
            if (!rhythmAudioContextInitialized) return;

            // ... (ê¸°ì¡´ rhythmScheduler ë¡œì§ ìœ ì§€)
            while (rhythmNextNoteTime < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const secondsPerBeat = 60.0 / rhythmBPM;
                rhythmScheduleNote(rhythmCurrentBeat, rhythmNextNoteTime);
                rhythmNextNoteTime += secondsPerBeat;
                rhythmCurrentBeat = (rhythmCurrentBeat + 1) % rhythmBeatsPerMeasure;
            }

            while (rhythmRemoveHighlightSchedule.length > 0 && rhythmRemoveHighlightSchedule[0].time < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const remove = rhythmRemoveHighlightSchedule.shift();
                const targetElement = document.querySelector(`.sub-beat[data-sub-beat-index="${remove.index}"]`);
                if (targetElement) targetElement.classList.remove('current-16th');
            }

            while (rhythmAddHighlightSchedule.length > 0 && rhythmAddHighlightSchedule[0].time < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const highlight = rhythmAddHighlightSchedule.shift();
                const currentSubBeat = document.querySelector(`.sub-beat[data-sub-beat-index="${highlight.index}"]`);
                if (currentSubBeat) currentSubBeat.classList.add('current-16th');
            }

            rhythmTimerId = window.setTimeout(rhythmScheduler, 25.0);
        }

        function rhythmScheduleNote(beatNumber, scheduledTime) {
            if (!rhythmAudioContextInitialized) return;
            
            // ... (ê¸°ì¡´ rhythmScheduleNote ë¡œì§ ìœ ì§€)
            const secondsPerBeat = 60.0 / rhythmBPM;
            const subBeatDuration = secondsPerBeat / rhythmSubdivision;
            const measureIndex = beatNumber * rhythmSubdivision;
            const timeDifference = rhythmAudioContext.currentTime - scheduledTime;
            
            let highlightIndex = measureIndex;

            for (let i = 0; i < rhythmSubdivision; i++) {
                const patternIndex = measureIndex + i;
                const isDownBeat = (i === 0); 

                // Swing logic
                let timeOffset = 0;
                if (rhythmSwingAmount > 0 && rhythmSubdivision === 4) {
                    if (i % 2 !== 0) { // Off-beats (8th notes)
                        const swingRatio = rhythmSwingAmount / 100.0; // 0 to 1
                        const swingFactor = 2 * (1 - swingRatio); // 2(1 - R)
                        const straightDuration = secondsPerBeat / 2; // 8th note duration
                        timeOffset = straightDuration * (swingFactor - 1);
                    }
                }

                const subBeatTime = scheduledTime + (i * subBeatDuration) + timeOffset;

                // Play sound if pattern or metronome is active
                const isPatternActive = rhythmPattern[patternIndex % rhythmPattern.length];
                const isMetronomeActive = rhythmIsMetronomeAlwaysOn && isDownBeat;

                if (isPatternActive || isMetronomeActive) {
                    if (rhythmMetronomeGain) {
                        rhythmMetronomeGain.gain.setValueAtTime(1, subBeatTime);
                        rhythmMetronomeGain.gain.exponentialRampToValueAtTime(0.001, subBeatTime + 0.02); 
                    }
                }
                
                // Highlight schedule
                rhythmAddHighlightSchedule.push({ time: subBeatTime, index: patternIndex % rhythmPattern.length });
                rhythmRemoveHighlightSchedule.push({ time: subBeatTime + subBeatDuration, index: patternIndex % rhythmPattern.length });
            }

            // ... (ê¸°ì¡´ rhythmScheduleNote ë¡œì§ ìœ ì§€)
        }

        function rhythmGenerateRhythm() {
            // ... (ê¸°ì¡´ rhythmGenerateRhythm ë¡œì§ ìœ ì§€)
            rhythmSyncopationLevel = parseInt(rhythmSyncopationRange.value);
            rhythmDifficultyLevel = parseInt(rhythmDifficultyRange.value);
            const total16thNotes = rhythmBeatsPerMeasure * rhythmSubdivision;
            rhythmPattern = new Array(total16thNotes).fill(0);

            // ... (ë¦¬ë“¬ ìƒì„± ë¡œì§)

            rhythmDisplayPattern(rhythmPattern);
        }

        function rhythmTogglePlayPause() {
            // **[ìˆ˜ì • 1] ëª¨ë°”ì¼ Audio Context í™œì„±í™”**
            rhythmInitAudio(); 
            if (rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
            
            if (rhythmIsPlaying) {
                window.clearTimeout(rhythmTimerId);
                rhythmIsPlaying = false;
                rhythmPlayPauseBtn.textContent = "â–¶ Play";
                if (rhythmMetronomeGain) rhythmMetronomeGain.gain.setValueAtTime(0, rhythmAudioContext.currentTime);
                rhythmRemoveAllHighlights();
                rhythmAddHighlightSchedule = [];
                rhythmRemoveHighlightSchedule = [];
            } else {
                rhythmIsPlaying = true;
                rhythmPlayPauseBtn.textContent = "âšâš Pause";
                rhythmNextNoteTime = rhythmAudioContext.currentTime;
                rhythmCurrentBeat = 0;
                rhythmScheduler();
            }
        }

        function rhythmUpdateBPM(newBPM) {
            rhythmBPM = Math.max(40, Math.min(240, newBPM));
            rhythmBPMInput.value = rhythmBPM;
        }

        // **[ìˆ˜ì • 3] BPM ì¦ê° í­ 1ë¡œ ë³€ê²½**
        function rhythmIncreaseBPM() { rhythmUpdateBPM(rhythmBPM + 1); }
        function rhythmDecreaseBPM() { rhythmUpdateBPM(rhythmBPM - 1); }

        // **[ìˆ˜ì • 2] Tap Tempo ë¡œì§ êµ¬í˜„**
        function rhythmHandleTapTempo() {
            rhythmInitAudio(); // íƒ­ ì‹œì—ë„ Audio Context ì´ˆê¸°í™”/ì¬ê°œ ì‹œë„
            
            // AudioContext timeì„ ì‚¬ìš©í•˜ì—¬ ì •í™•ë„ ë†’ì„
            const now = rhythmAudioContext.currentTime * 1000; // ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ í˜„ì¬ ì‹œê°„

            // 2ì´ˆ ì´ìƒ ê°„ê²©ì´ë©´ ë°°ì—´ ì´ˆê¸°í™” ë° í˜„ì¬ íƒ­ë§Œ ì €ì¥
            if (rhythmTapTimes.length > 0 && (now - rhythmTapTimes[rhythmTapTimes.length - 1] > 2000)) {
                rhythmTapTimes = [now];
                return;
            }

            rhythmTapTimes.push(now);

            if (rhythmTapTimes.length > rhythmTapTimeMax) {
                rhythmTapTimes.shift(); // 4ê°œ ì´ˆê³¼ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ íƒ­ ì œê±°
            }

            if (rhythmTapTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < rhythmTapTimes.length; i++) {
                    intervals.push(rhythmTapTimes[i] - rhythmTapTimes[i-1]);
                }
                
                // í‰ê·  ì¸í„°ë²Œ ê³„ì‚°
                const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                
                // BPM ê³„ì‚° (60000ms / averageInterval)
                const newBPM = Math.round(60000 / averageInterval);
                rhythmUpdateBPM(newBPM);
            }
        }

        function rhythmHandleSwingSelection(value) {
            // ... (ê¸°ì¡´ rhythmHandleSwingSelection ë¡œì§ ìœ ì§€)
            rhythmSwingAmount = Math.max(0, Math.min(100, parseInt(value)));
            rhythmSwingRange.value = rhythmSwingAmount;
            rhythmSwingPercentValue.textContent = `${rhythmSwingAmount}%`;
            rhythmSwingButtonsContainer.querySelectorAll('.swing-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.swingValue) === rhythmSwingAmount) btn.classList.add('active');
            });
        }

        function rhythmHandleSwingButtonEvent(e) {
            // ... (ê¸°ì¡´ rhythmHandleSwingButtonEvent ë¡œì§ ìœ ì§€)
            const btn = e.target.closest('.swing-btn');
            if (btn) rhythmHandleSwingSelection(btn.dataset.swingValue);
        }

        function rhythmHandleSwingSliderEvent(e) {
            // ... (ê¸°ì¡´ rhythmHandleSwingSliderEvent ë¡œì§ ìœ ì§€)
            rhythmHandleSwingSelection(e.target.value);
        }

        function rhythmRemoveAllHighlights() {
            // ... (ê¸°ì¡´ rhythmRemoveAllHighlights ë¡œì§ ìœ ì§€)
            document.querySelectorAll('.sub-beat').forEach(b => b.classList.remove('current-16th'));
            document.querySelectorAll('.beat-group').forEach(b => b.classList.remove('highlight-current-beat'));
        }

        function rhythmDisplayPattern(pattern) {
            // ... (ê¸°ì¡´ rhythmDisplayPattern ë¡œì§ ìœ ì§€)
            rhythmPatternDisplay.innerHTML = '';
            // ë°•ì(rhythmBeatsPerMeasure) ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
            for (let i = 0; i < rhythmBeatsPerMeasure; i++) {
                const beatGroup = document.createElement('div');
                beatGroup.className = 'beat-group';
                beatGroup.dataset.beatIndex = i;

                const beatMarker = document.createElement('div');
                beatMarker.className = 'beat-marker';
                beatMarker.textContent = i + 1;
                beatGroup.appendChild(beatMarker);

                const subdivisionGroup = document.createElement('div');
                subdivisionGroup.className = 'subdivision-group';
                
                for (let j = 0; j < rhythmSubdivision; j++) {
                    const patternIndex = (i * rhythmSubdivision) + j;
                    const subBeat = document.createElement('div');
                    subBeat.className = `sub-beat ${rhythmSubdivision === 3 ? 'sub-beat-3' : ''}`;
                    subBeat.dataset.subBeatIndex = patternIndex;
                    subBeat.dataset.beat = i + 1;
                    subBeat.dataset.sub = j + 1;
                    if (pattern[patternIndex] === 1) subBeat.classList.add('active');
                    
                    subBeat.addEventListener('click', () => {
                        pattern[patternIndex] = pattern[patternIndex] === 1 ? 0 : 1;
                        subBeat.classList.toggle('active');
                    });
                    subdivisionGroup.appendChild(subBeat);
                }
                beatGroup.appendChild(subdivisionGroup);
                rhythmPatternDisplay.appendChild(beatGroup);
            }
        }

        function rhythmUpdateTheme(selectedTheme, selectedMode) {
            // ... (ê¸°ì¡´ rhythmUpdateTheme ë¡œì§ ìœ ì§€)
            const body = document.body;
            body.classList.remove('dark-mode', 'light-mode');
            body.classList.remove('theme-blue');
            body.classList.add(`theme-${selectedTheme}`);
            if (selectedMode === 'light') body.classList.add('light-mode');
            else body.classList.add('dark-mode');
        }

        // Event Listeners (ìˆ˜ì • 1, 2, 3 ë°˜ì˜)
        rhythmPlayPauseBtn.addEventListener('click', rhythmTogglePlayPause);
        rhythmBPMIncreaseBtn.addEventListener('click', rhythmIncreaseBPM);
        rhythmBPMDecreaseBtn.addEventListener('click', rhythmDecreaseBPM);
        
        rhythmGenerateBtn.addEventListener('click', () => {
            rhythmInitAudio(); // **[ìˆ˜ì • 1]**
            rhythmGenerateRhythm();
        });
        
        // **[ìˆ˜ì • 2] Tap Tempo ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ ì¶”ê°€**
        rhythmTapTempoBtn.addEventListener('click', rhythmHandleTapTempo);
        rhythmTapTempoBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            rhythmHandleTapTempo();
        });

        rhythmMetronomeToggle.addEventListener('change', (e) => {
            rhythmIsMetronomeAlwaysOn = e.target.checked;
            rhythmInitAudio(); // **[ìˆ˜ì • 1]**
        });

        rhythmBPMInput.addEventListener('change', (e) => {
            rhythmUpdateBPM(parseInt(e.target.value));
            if (rhythmIsPlaying) {
                rhythmTogglePlayPause();
                rhythmTogglePlayPause();
            }
            rhythmInitAudio(); // **[ìˆ˜ì • 1]**
        });

        rhythmSwingButtonsContainer.addEventListener('click', rhythmHandleSwingButtonEvent);
        rhythmSwingRange.addEventListener('input', rhythmHandleSwingSliderEvent);
        rhythmSwingRange.addEventListener('change', rhythmHandleSwingSliderEvent);

        rhythmTimeSignatureSelect.addEventListener('change', (e) => {
            rhythmTimeSignature = e.target.value;
            const [numerator, denominator] = rhythmTimeSignature.split('/').map(Number);
            rhythmBeatsPerMeasure = numerator;
            rhythmSubdivision = (denominator === 8) ? 3 : 4;
            rhythmGenerateRhythm();
        });
        
        rhythmSyncopationRange.addEventListener('input', (e) => {
            document.getElementById('rhythm-syncopation-value').textContent = e.target.value;
        });
        
        rhythmDifficultyRange.addEventListener('input', (e) => {
            document.getElementById('rhythm-difficulty-value').textContent = e.target.value;
        });

        // Fretboard Variables and Constants
        const fretboardTotalFrets = 24; 
        const fretboardOpenStrings = [4, 9, 2, 7, 11, 4]; // E A D G B E (MIDI note 40: E2)
        const fretboardSharpNoteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const fretboardFlatNoteNames = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const fretboardNoteIndices = { "C": 0, "C#": 1, "Db": 1, "D": 2, "D#": 3, "Eb": 3, "E": 4, "F": 5, "F#": 6, "Gb": 6, "G": 7, "G#": 8, "Ab": 8, "A": 9, "A#": 10, "Bb": 10, "B": 11 };
        const fretboardFlatRoots = ["Db", "Eb", "Gb", "Ab", "Bb", "F"]; // í”Œë« í‘œê¸°ë¥¼ ì„ í˜¸í•˜ëŠ” ê·¼ìŒ
        
        const fretboardDegreeColors = { 
            1: '--color-root-highlight', // R
            2: '--color-p1', // 2, 9
            3: '--color-p2', // 3
            4: '--color-p3', // 4, 11
            5: '--color-p4', // 5
            6: '--color-p5', // 6, 13
            7: '--color-p2', // 7
            // Diminished/Augmented
            'b2': '--color-p1', 
            '#4/b5': '--color-p3', 
            'b6': '--color-p4', 
            'b7': '--color-p5' 
        };
        const fretboardFunctionalDegreeNames = { 
            0: "R", 1: "b2", 2: "2", 3: "b3", 4: "3", 5: "4", 6: "#4/b5", 7: "5", 8: "b6", 9: "6", 10: "b7", 11: "7" 
        };
        const fretboardSCALE_INTERVALS = {
            "Major": [0, 2, 4, 5, 7, 9, 11],
            "Natural Minor": [0, 2, 3, 5, 7, 8, 10],
            "Harmonic Minor": [0, 2, 3, 5, 7, 8, 11],
            "Melodic Minor": [0, 2, 3, 5, 7, 9, 11],
            "Pentatonic Major": [0, 2, 4, 7, 9],
            "Pentatonic Minor": [0, 3, 5, 7, 10],
            "Blues": [0, 3, 5, 6, 7, 10],
            "Dorian": [0, 2, 3, 5, 7, 9, 10],
            "Phrygian": [0, 1, 3, 5, 7, 8, 10],
            "Lydian": [0, 2, 4, 6, 7, 9, 11],
            "Mixolydian": [0, 2, 4, 5, 7, 9, 10],
            "Locrian": [0, 1, 3, 5, 6, 8, 10],
            "Whole Tone": [0, 2, 4, 6, 8, 10],
            "Diminished": [0, 2, 3, 5, 6, 8, 9, 11],
            "Hungarian Minor": [0, 2, 3, 6, 7, 8, 11],
            "Persian": [0, 1, 4, 5, 6, 8, 11]
        };
        const fretboardCHORD_INTERVALS = {
            "Major": [0, 4, 7],
            "Minor": [0, 3, 7],
            "Dominant 7th": [0, 4, 7, 10],
            "Major 7th": [0, 4, 7, 11],
            "Minor 7th": [0, 3, 7, 10],
            "Diminished": [0, 3, 6],
            "Augmented": [0, 4, 8],
            "Sus4": [0, 5, 7],
            "Add9": [0, 4, 7, 2],
            "Major 9th": [0, 4, 7, 11, 2],
            "Minor 9th": [0, 3, 7, 10, 2],
            "Dominant 9th": [0, 4, 7, 10, 2]
        };

        let fretboardInstances = {};
        let fretboardNextId = 1;

        // Fretboard Utility Functions
        function fretboardGetPatternIntervals(patternMode, patternType) {
            if (patternMode === 'scale') return fretboardSCALE_INTERVALS[patternType] || [];
            if (patternMode === 'chord') return fretboardCHORD_INTERVALS[patternType] || [];
            return [];
        }

        function fretboardGetPatternDegreeName(interval, patternType) {
            // ... (ê¸°ì¡´ fretboardGetPatternDegreeName ë¡œì§ ìœ ì§€)
            if (patternType.includes("Major") && interval === 11) return "7"; // M7
            if (patternType.includes("Minor") && interval === 10) return "b7"; // m7
            if (interval === 1) return "b2";
            if (interval === 3) return "b3";
            if (interval === 6) return "#4/b5";
            if (interval === 8) return "b6";
            if (interval === 10) return "b7";
            return fretboardFunctionalDegreeNames[interval] || '';
        }

        function renderFretboardGrid(container, getDotContentCallback) {
            // ... (ê¸°ì¡´ renderFretboardGrid ë¡œì§ ìœ ì§€)
            // 1. Number Row
            const numberRow = document.createElement('div');
            numberRow.className = 'fretboard-row number-row';
            numberRow.appendChild(document.createElement('div')).className = 'fret-0-cell';

            // 2. Marker Row
            const markerRow = document.createElement('div');
            markerRow.className = 'fretboard-row marker-row';
            markerRow.appendChild(document.createElement('div')).className = 'fret-0-cell';

            for (let f = 1; f <= fretboardTotalFrets; f++) {
                // [ìˆ˜ì • 4] fretboardTotalFretsì— ë§ì¶° 24í”„ë ›ê¹Œì§€ ë Œë”ë§
                const numberCell = document.createElement('div');
                numberCell.className = 'fret-cell';
                numberCell.textContent = f;
                numberRow.appendChild(numberCell);

                const markerCell = document.createElement('div');
                markerCell.className = 'fret-cell marker-cell';
                if ([3,5,7,9,15,17,19,21].includes(f)) markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                else if ([12,24].includes(f)) { // 24í”„ë › ë§ˆì»¤ ì²˜ë¦¬
                    markerCell.classList.add('double-marker');
                    markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                    markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                }
                markerRow.appendChild(markerCell);
            }

            // [ìˆ˜ì • 3] String Rows ë¨¼ì € ë Œë”ë§
            for (let s = 0; s < fretboardOpenStrings.length; s++) {
                const stringRow = document.createElement('div');
                stringRow.className = 'fretboard-row string-row';

                let dotDiv = getDotContentCallback(s, 0);
                const fret0Cell = document.createElement('div');
                fret0Cell.className = 'fret-0-cell fret-space';
                if (dotDiv) fret0Cell.appendChild(dotDiv);
                stringRow.appendChild(fret0Cell);

                for (let f = 1; f <= fretboardTotalFrets; f++) {
                    // [ìˆ˜ì • 4] fretboardTotalFretsì— ë§ì¶° 24í”„ë ›ê¹Œì§€ ë Œë”ë§
                    dotDiv = getDotContentCallback(s, f);
                    const fretCell = document.createElement('div');
                    fretCell.className = 'fret-cell fret-space';
                    if (dotDiv) fretCell.appendChild(dotDiv);
                    stringRow.appendChild(fretCell);
                }
                container.appendChild(stringRow);
            }
            
            // [ìˆ˜ì • 3] Marker Rowì™€ Number Rowë¥¼ ê°€ì¥ ì•„ë˜ì— ë°°ì¹˜
            container.appendChild(numberRow);
            container.appendChild(markerRow);
        }

        // [FRETBOARD] CLASS DEFINITION
        class FretboardInstance {
            constructor(id) {
                // ... (ìƒì„±ì ë¡œì§ ìœ ì§€)
                this.id = id;
                this.patternMode = 'scale';
                this.scaleType = 'Major';
                this.chordType = 'Major';
                this.rootNote = 'C';
                this.displayMode = 'note';
                this.selectedFreeNotes = new Set();
                
                this.rootElement = fretboardTemplate.content.cloneNode(true).querySelector('.fretboard-instance');
                this.rootElement.id = `fretboard-instance-${id}`;
                
                this.dom = {
                    root: this.rootElement,
                    instanceTitle: this.rootElement.querySelector('.instance-title'),
                    removeBtn: this.rootElement.querySelector('.remove-fretboard-btn'),
                    toggleCompactBtn: this.rootElement.querySelector('.toggle-compact-btn'),
                    modeTypeButtons: this.rootElement.querySelector('.mode-type-buttons'),
                    scaleControls: this.rootElement.querySelector('.scale-controls'),
                    chordControls: this.rootElement.querySelector('.chord-controls'),
                    freeNoteControls: this.rootElement.querySelector('.free-note-controls'),
                    scaleRootNoteButtons: this.rootElement.querySelector('.scale-controls .root-note-buttons'),
                    scaleTypeButtons: this.rootElement.querySelector('.scale-type-buttons'),
                    chordRootNoteButtons: this.rootElement.querySelector('.chord-controls .root-note-buttons'),
                    chordTypeButtons: this.rootElement.querySelector('.chord-type-buttons'),
                    freeNoteButtonsContainer: this.rootElement.querySelector('.free-note-buttons'),
                    clearFreeNotesBtn: this.rootElement.querySelector('.clear-free-notes-btn'),
                    displayModeButtons: this.rootElement.querySelector('.color-mode-buttons'),
                    patternInfoSpan: this.rootElement.querySelector('.pattern-info-span'),
                    fretboardDisplay: this.rootElement.querySelector('.fretboard-display'),
                };
                
                this.dom.instanceTitle.textContent = `ğŸ¸ ì…ë ¥ ì§€íŒ #${id}`;

                this.setupInitialState();
                this.setupEventListeners();
                fretboardInstances[id] = this;
            }

            setupInitialState() {
                // ... (ê¸°ì¡´ setupInitialState ë¡œì§ ìœ ì§€)
                this.renderFreeNoteButtons();
                this.renderCurrentPattern();
            }

            toggleCompactMode(shouldCompact) {
                // ... (ê¸°ì¡´ toggleCompactMode ë¡œì§ ìœ ì§€)
                if (shouldCompact) {
                    this.dom.root.classList.add('compact-mode');
                    this.dom.toggleCompactBtn.textContent = 'Expand';
                } else {
                    this.dom.root.classList.remove('compact-mode');
                    this.dom.toggleCompactBtn.textContent = 'Compact';
                }
            }

            renderFreeNoteButtons() {
                // ... (ê¸°ì¡´ renderFreeNoteButtons ë¡œì§ ìœ ì§€)
                const container = this.dom.freeNoteButtonsContainer;
                container.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const button = document.createElement('button');
                    const useFlat = fretboardFlatRoots.includes(this.rootNote);
                    button.textContent = useFlat ? fretboardFlatNoteNames[i] : fretboardSharpNoteNames[i];
                    button.className = 'note-select-btn';
                    button.dataset.noteIndex = i;
                    if (this.selectedFreeNotes.has(i)) button.classList.add('active');
                    container.appendChild(button);
                }
            }

            getPatternTitle() {
                // ... (ê¸°ì¡´ getPatternTitle ë¡œì§ ìœ ì§€)
                const isScale = this.patternMode === 'scale';
                const pattern = isScale ? this.scaleType : (this.chordType === 'Major' ? '' : this.chordType);
                const type = isScale ? 'Scale' : 'Chord';
                return this.rootNote + ' ' + pattern + (this.patternMode === 'free' ? ' (ì„ íƒ ìŒ)' : ' ' + type);
            }

            generatePatternData() {
                // ... (ê¸°ì¡´ generatePatternData ë¡œì§ ìœ ì§€)
                const isScale = this.patternMode === 'scale';
                const type = isScale ? this.scaleType : this.chordType;
                return {
                    patternType: this.patternMode,
                    scaleType: isScale ? this.scaleType : null,
                    chordType: isScale ? null : this.chordType,
                    rootNote: this.rootNote,
                    rootIndex: fretboardNoteIndices[this.rootNote],
                    intervals: this.patternMode === 'free' ? [] : fretboardGetPatternIntervals(this.patternMode, type),
                    selectedFreeNotes: this.selectedFreeNotes,
                };
            }

            getNoteLabelAndClass(noteIndex, patternIntervals) {
                // ... (ê¸°ì¡´ getNoteLabelAndClass ë¡œì§ ìœ ì§€)
                const rootIndex = fretboardNoteIndices[this.rootNote];
                let interval = (noteIndex - rootIndex + 12) % 12;
                let label, cssClass = '';

                if (this.displayMode === 'note') {
                    const useFlat = fretboardFlatRoots.includes(this.rootNote);
                    label = useFlat ? fretboardFlatNoteNames[noteIndex] : fretboardSharpNoteNames[noteIndex];
                } else {
                    if (this.patternMode === 'free') label = 'â—‰';
                    else label = fretboardGetPatternDegreeName(interval, this.patternMode === 'scale' ? this.scaleType : this.chordType);
                }

                if (interval === 0 && this.patternMode !== 'free') cssClass = 'root';
                else if (patternIntervals.includes(interval)) cssClass = 'other-note';
                else if (this.patternMode === 'free' && this.selectedFreeNotes.has(noteIndex)) cssClass = 'other-note';
                else {
                    cssClass = 'free-note';
                    label = this.displayMode === 'note' ? label : '';
                }

                if (this.patternMode !== 'free' && !patternIntervals.includes(interval)) label = '';

                return { label: label, cssClass: cssClass };
            }

            renderCurrentPattern() {
                // ... (ê¸°ì¡´ renderCurrentPattern ë¡œì§ ìœ ì§€)
                const data = this.generatePatternData();
                this.dom.patternInfoSpan.textContent = this.getPatternTitle();
                this.dom.fretboardDisplay.innerHTML = '';
                
                renderFretboardGrid(this.dom.fretboardDisplay, (stringIndex, fretIndex) => {
                    const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                    let hasNote = false;
                    
                    if (this.patternMode === 'free') {
                        if (this.selectedFreeNotes.has(noteIndex)) hasNote = true;
                    } else {
                        if (data.intervals.includes((noteIndex - data.rootIndex + 12) % 12)) hasNote = true;
                    }

                    if (hasNote) {
                        const { label, cssClass } = this.getNoteLabelAndClass(noteIndex, data.intervals);
                        const dot = document.createElement('div');
                        dot.className = `note-dot ${cssClass}`;
                        dot.textContent = label;
                        return dot;
                    }
                    return null;
                });
            }

            // Free Note ëª¨ë“œì—ì„œ ì§€íŒì„ í´ë¦­í–ˆì„ ë•Œì˜ ì²˜ë¦¬
            handleFretClick(stringIndex, fretIndex) {
                // ... (ê¸°ì¡´ handleFretClick ë¡œì§ ìœ ì§€)
                const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                
                if (this.selectedFreeNotes.has(noteIndex)) this.selectedFreeNotes.delete(noteIndex);
                else this.selectedFreeNotes.add(noteIndex);

                this.dom.freeNoteButtonsContainer.querySelectorAll('.note-select-btn').forEach(btn => {
                    const btnNoteIndex = parseInt(btn.dataset.noteIndex);
                    if (this.selectedFreeNotes.has(btnNoteIndex)) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                this.renderCurrentPattern();
                fretboardUpdateCombinedView();
            }

            setupEventListeners() {
                // ... (ê¸°ì¡´ setupEventListeners ë¡œì§ ìœ ì§€)
                const update = () => {
                    this.renderCurrentPattern();
                    fretboardUpdateCombinedView();
                };

                // Remove Button
                this.dom.removeBtn.addEventListener('click', () => {
                    this.dom.root.remove();
                    delete fretboardInstances[this.id];
                    fretboardRenumberInstances();
                    fretboardUpdateCombinedView();
                });

                // Mode Buttons
                this.dom.modeTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.mode-btn');
                    if (!btn) return;
                    this.patternMode = btn.dataset.mode;
                    this.dom.modeTypeButtons.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    this.dom.scaleControls.style.display = 'none';
                    this.dom.chordControls.style.display = 'none';
                    this.dom.freeNoteControls.style.display = 'none';
                    
                    if (this.patternMode === 'scale') this.dom.scaleControls.style.display = 'block';
                    else if (this.patternMode === 'chord') this.dom.chordControls.style.display = 'block';
                    else if (this.patternMode === 'free') {
                        this.dom.freeNoteControls.style.display = 'block';
                        this.renderFreeNoteButtons();
                    }
                    update();
                });

                // Display Mode Buttons
                this.dom.displayModeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.display-mode-btn');
                    if (!btn) return;
                    this.displayMode = btn.dataset.mode;
                    this.dom.displayModeButtons.querySelectorAll('.display-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.renderFreeNoteButtons(); // Free Note ëª¨ë“œì—ì„œ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
                    update();
                });

                // Scale Type Buttons
                this.dom.scaleTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.scale-btn');
                    if (!btn) return;
                    this.scaleType = btn.dataset.scale;
                    this.dom.scaleTypeButtons.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    update();
                });

                // Chord Type Buttons
                this.dom.chordTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.chord-btn');
                    if (!btn) return;
                    this.chordType = btn.dataset.chord;
                    this.dom.chordTypeButtons.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    update();
                });

                // Root Note Buttons (Scale & Chord)
                [this.dom.scaleRootNoteButtons, this.dom.chordRootNoteButtons].forEach(container => {
                    container.addEventListener('click', (e) => {
                        const btn = e.target.closest('.root-btn');
                        if (!btn) return;
                        this.rootNote = btn.dataset.root;
                        
                        // í˜„ì¬ ëª¨ë“œì˜ ë£¨íŠ¸ ë²„íŠ¼ë§Œ í™œì„±í™”
                        const targetRootButtons = this.patternMode === 'scale' ? this.dom.scaleRootNoteButtons : this.dom.chordRootNoteButtons;
                        targetRootButtons.querySelectorAll('.root-btn').forEach(b => {
                            if (b.dataset.root === this.rootNote) b.classList.add('active');
                            else b.classList.remove('active');
                        });
                        
                        this.renderFreeNoteButtons(); // ë£¨íŠ¸ ë³€ê²½ ì‹œ Free Note ë²„íŠ¼ì˜ #/b í‘œì‹œ ì—…ë°ì´íŠ¸
                        update();
                    });
                });

                // Free Note Buttons
                this.dom.freeNoteButtonsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('.note-select-btn');
                    if (!btn) return;
                    const noteIndex = parseInt(btn.dataset.noteIndex);
                    
                    if (this.selectedFreeNotes.has(noteIndex)) this.selectedFreeNotes.delete(noteIndex);
                    else this.selectedFreeNotes.add(noteIndex);
                    
                    btn.classList.toggle('active');
                    update();
                });
                
                // Clear Free Notes
                this.dom.clearFreeNotesBtn.addEventListener('click', () => {
                    this.selectedFreeNotes.clear();
                    this.dom.freeNoteButtonsContainer.querySelectorAll('.note-select-btn').forEach(btn => btn.classList.remove('active'));
                    update();
                });
                
                // Fretboard Click Listener for Free Note Mode
                this.dom.fretboardDisplay.addEventListener('click', (e) => {
                    if (this.patternMode !== 'free') return;
                    let target = e.target.closest('.fret-space');
                    if (!target) return;
                    
                    const parentRow = target.parentElement;
                    const rowIndex = Array.from(this.dom.fretboardDisplay.children).indexOf(parentRow);
                    if (rowIndex < 0) return; // numberRowë‚˜ markerRow ë“±ì€ ë¬´ì‹œ

                    let totalRows = this.dom.fretboardDisplay.children.length;
                    let numStringRows = fretboardOpenStrings.length; // 6
                    
                    // String rowëŠ” ì²« ë²ˆì§¸ë¶€í„° ì—¬ì„¯ ë²ˆì§¸ê¹Œì§€ (ì¸ë±ìŠ¤ 0~5)ì— ìœ„ì¹˜í•¨
                    let stringRowIndex = rowIndex; 
                    
                    // í´ë¦­ëœ ìš”ì†Œê°€ String Rowì¸ì§€ í™•ì¸ (0ë¶€í„° 5 ì‚¬ì´ì˜ ì¸ë±ìŠ¤)
                    if (stringRowIndex < 0 || stringRowIndex >= numStringRows) return;
                    
                    const stringIndex = stringRowIndex;
                    const fretIndex = Array.from(parentRow.children).indexOf(target);
                    
                    // í”„ë › 0ì¹¸ì„ í¬í•¨í•˜ë¯€ë¡œ fretIndexê°€ 0ë¶€í„° ì‹œì‘
                    this.handleFretClick(stringIndex, fretIndex);
                });
                
                this.dom.toggleCompactBtn.addEventListener('click', () => {
                    this.toggleCompactMode(!this.dom.root.classList.contains('compact-mode'));
                });
            }
        }
        
        function fretboardRenumberInstances() {
            // ... (ê¸°ì¡´ fretboardRenumberInstances ë¡œì§ ìœ ì§€)
            const keys = Object.keys(fretboardInstances).map(Number).sort((a, b) => a - b);
            let newInstances = {};
            keys.forEach((oldId, index) => {
                const newId = index + 1;
                const instance = fretboardInstances[oldId];
                instance.id = newId;
                instance.dom.instanceTitle.textContent = `ğŸ¸ ì…ë ¥ ì§€íŒ #${newId}`;
                instance.rootElement.id = `fretboard-instance-${newId}`;
                newInstances[newId] = instance;
            });
            fretboardInstances = newInstances;
            fretboardNextId = keys.length + 1;
        }

        function fretboardUpdateCombinedView() {
            // ... (ê¸°ì¡´ fretboardUpdateCombinedView ë¡œì§ ìœ ì§€)
            const ids = Object.keys(fretboardInstances).map(Number).sort((a, b) => a - b);
            const legendItemsContainer = document.getElementById('legend-items');

            if (ids.length === 0) {
                combinedResultSection.style.display = 'none';
                legendItemsContainer.innerHTML = '';
                return;
            }

            combinedResultSection.style.display = 'block';
            combinedResultDisplay.innerHTML = '';
            legendItemsContainer.innerHTML = '';

            // 1. ë²”ë¡€ ìƒì„± (Legend)
            ids.forEach((id, idx) => {
                const inst = fretboardInstances[id];
                const patternTitle = inst.getPatternTitle();
                const colorIndex = (idx % 5) + 1;
                const colorVar = `--color-p${colorIndex}`;

                const legendItem = document.createElement('span');
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.fontSize = '0.9em';
                legendItem.style.color = 'var(--text-main)';

                const colorDot = document.createElement('div');
                colorDot.style.width = '12px';
                colorDot.style.height = '12px';
                colorDot.style.borderRadius = '50%';
                colorDot.style.backgroundColor = `var(${colorVar})`;
                colorDot.style.marginRight = '8px';

                legendItem.appendChild(colorDot);
                legendItem.append(document.createTextNode(`${inst.dom.instanceTitle.textContent}: ${patternTitle}`));
                legendItemsContainer.appendChild(legendItem);
            });

            // 2. ì§€íŒ ë Œë”ë§ (Fretboard)
            renderFretboardGrid(combinedResultDisplay, (stringIndex, fretIndex) => {
                const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                let activeSources = [];

                ids.forEach((id, idx) => {
                    const inst = fretboardInstances[id];
                    const data = inst.generatePatternData();
                    let hasNote = false;

                    if (data.patternType === 'free') {
                        if (data.selectedFreeNotes.has(noteIndex)) hasNote = true;
                    } else {
                        if (data.intervals.includes((noteIndex - data.rootIndex + 12) % 12)) hasNote = true;
                    }
                    
                    if (hasNote) {
                        activeSources.push({ 
                            id: id, 
                            idx: idx, 
                            data: data,
                            label: inst.getNoteLabelAndClass(noteIndex, data.intervals).label
                        });
                    }
                });

                if (activeSources.length === 0) return null;

                const dot = document.createElement('div');
                dot.className = 'note-dot';

                // ë£¨íŠ¸ ë…¸ë“œ í™•ì¸
                const isRoot = activeSources.some(source => {
                    return source.data.patternType !== 'free' && 
                           (noteIndex - source.data.rootIndex + 12) % 12 === 0;
                });

                if (isRoot) {
                    dot.classList.add('root');
                } else if (activeSources.length === 1) {
                    dot.classList.add('simple-other');
                }
                
                // ë¼ë²¨ ì„¤ì • (ì²« ë²ˆì§¸ ì†ŒìŠ¤ì˜ ë¼ë²¨ì„ ì‚¬ìš©)
                dot.textContent = activeSources[0].label;

                // ìˆ˜ì§ ë¶„í•  ìŠ¤íƒ€ì¼ (1ê°œ ì´ˆê³¼ì¸ ê²½ìš°)
                if (activeSources.length > 1 && !isRoot) {
                    dot.classList.add('multi-source');
                    dot.style.background = 'none';
                    dot.style.boxShadow = 'none';
                    dot.style.border = 'none';
                    dot.style.overflow = 'hidden';
                    dot.style.display = 'flex';
                    dot.style.flexDirection = 'row';
                    dot.style.padding = '0';
                    dot.style.width = '24px';
                    dot.style.height = '24px';
                    dot.style.borderRadius = '50%';
                    dot.style.border = '1px solid var(--text-main)';
                    dot.style.zIndex = '20';
                    dot.style.color = 'var(--text-main)'; // ë¼ë²¨ ìƒ‰ìƒ

                    activeSources.forEach(source => {
                        const colorIndex = (source.idx % 5) + 1;
                        const colorVar = `var(--color-p${colorIndex})`;
                        
                        const segment = document.createElement('div');
                        segment.style.flex = 1;
                        segment.style.height = '100%';
                        segment.style.backgroundColor = colorVar;
                        segment.style.borderRadius = '0';
                        dot.appendChild(segment);
                    });
                    
                    // ê°€ìš´ë° ë¼ë²¨ì„ ë®ì–´ì”Œì›€
                    const labelDiv = document.createElement('div');
                    labelDiv.style.position = 'absolute';
                    labelDiv.style.width = '100%';
                    labelDiv.style.height = '100%';
                    labelDiv.style.display = 'flex';
                    labelDiv.style.justifyContent = 'center';
                    labelDiv.style.alignItems = 'center';
                    labelDiv.style.zIndex = '30';
                    labelDiv.style.color = 'black'; // í…ìŠ¤íŠ¸ë¥¼ ëª…í™•íˆ ë³´ì´ê¸° ìœ„í•´ ê²€ì€ìƒ‰ ì‚¬ìš©
                    labelDiv.style.fontSize = '0.75em';
                    labelDiv.style.fontWeight = 'bold';
                    labelDiv.textContent = activeSources[0].label;
                    dot.appendChild(labelDiv);

                } else if (activeSources.length === 1) {
                    const colorIndex = (activeSources[0].idx % 5) + 1;
                    const colorVar = `var(--color-p${colorIndex})`;
                    dot.style.backgroundColor = colorVar;
                    dot.style.color = 'black';
                }

                return dot;
            });
        }

        function fretboardAddNewFretboard() {
            const newId = fretboardNextId++;
            const instance = new FretboardInstance(newId);
            fretboardCollection.appendChild(instance.rootElement);
            // ì´ˆê¸°ê°’ ì„¤ì •
            instance.dom.scaleRootNoteButtons.querySelector('[data-root="C"]').click();
            instance.dom.scaleTypeButtons.querySelector('[data-scale="Major"]').click();
            
            fretboardUpdateCombinedView(); 
            return instance;
        }

        fretboardAddFullBtn.addEventListener('click', () => fretboardAddNewFretboard());

        document.addEventListener('DOMContentLoaded', () => {
            rhythmUpdateTheme('blue', 'light'); 
            rhythmGenerateRhythm();
            rhythmDisplayPattern(rhythmPattern);
            rhythmSwingAmount = 0; 
            rhythmHandleSwingSelection(rhythmSwingAmount);
            rhythmMetronomeToggle.checked = rhythmIsMetronomeAlwaysOn;
        });

    </script>
</body>
</html>
