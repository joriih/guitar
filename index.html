<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¸°íƒ€ ë¿Œì…”ë¿Œì…” (Mobile Optimized)</title>
    <style>
        /* ========================================================= */
        /* === í†µí•©ëœ CSS ë³€ìˆ˜ === */
        /* ========================================================= */
        :root {
            /* ë¦¬ë“¬ ìŠ¤í…Œì´ì…˜ ê¸°ë³¸ í…Œë§ˆ ë³€ìˆ˜ */
            --bg-primary: #020e16; 
            --bg-panel: #1a1a3a; 
            --text-main: #f0f0f0; 
            --text-secondary: #aaaaaa; 
            --color-panel-border: #3c3c6e; 
            --color-input-bg: #2a2a4a; 
            --color-accent: #87ceeb; 
            --color-highlight: #87ceeb; 
            --color-indicator: #dc3545; 

            /* ì§€íŒ ì‹œê°í™” ê³ ìœ  ë³€ìˆ˜ */
            --color-simple-other: #bbbbbb; /* íšŒìƒ‰ (ê¸°íƒ€ ìŒ) */
            --color-divider: #cccccc; 
            
            --color-root-highlight: #ff0055; 
            --color-root-border: #ffffff;
            
            /* í†µí•© ì§€íŒ ë²”ë¡€/ë¶„í• ì„ ìœ„í•œ ìƒ‰ìƒ (5ê°€ì§€) */
            --color-p1: #FFB347; /* Pastel Orange */
            --color-p2: #87CEEB; /* Sky Blue */
            --color-p3: #77DD77; /* Pastel Green */
            --color-p4: #9370DB; /* Medium Purple */
            --color-p5: #DDA0DD; /* Plum (Light Purple) */
            
            --fret-0-width: 40px; 
            --fret-width: 60px;
            --dot-color: #ccc;
        }

        /* === ìƒ‰ìƒ í…Œë§ˆ ì •ì˜ === */
        .theme-blue {
            --color-accent: #87ceeb; 
            --color-highlight: #87ceeb; 
            --color-indicator: #3567dc; 
        }
        .instance-title{ display: none;}
        
        /* === Light Mode Overrides === */
        .light-mode {
            --bg-primary: #f0f0f5; 
            --bg-panel: #ffffff; 
            --text-main: #333333;
            --text-secondary: #666666;
            --color-panel-border: #e0e0e0;
            --color-input-bg: #f8f8f8;
        }

        /* ========================================================= */
        /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        /* ========================================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent; /* ëª¨ë°”ì¼ íƒ­ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
        }
        .header {
            width: 100%;
            max-width: 960px;
            justify-content: flex-start; 
            align-items: center;
            margin-bottom: 30px;
        }
        h1 { color: var(--text-main); font-size: 2.2em; margin: 0; }
        
        /* ìƒë‹¨ ì»¨í…Œì´ë„ˆ (ì„¤ì •, í…œí¬) */
        .top-container {
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            max-width: 960px;
            width: 100%; 
            justify-content: center; 
            margin-bottom: 20px;
        }
        
        .pattern-panel {
            background-color: var(--bg-panel); border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); width: 100%;
            max-width: 960px; margin: 0 auto 20px auto; transition: background-color 0.3s;
        }
        .panel {
            background-color: var(--bg-panel); border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); flex: 1; min-width: 280px;
            transition: background-color 0.3s;
        }
        h2 {
            color: var(--text-main); font-size: 1.4em; margin-top: 0;
            margin-bottom: 20px; 
            padding-bottom: 10px;
        }
        .setting-item { margin-bottom: 25px; }
        button {
            background-color: var(--color-accent); color: var(--bg-primary); 
            border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer;
            font-size: 1.1em;  transition: background-color 0.3s ease, opacity 0.2s;
            width: 100%; margin-top: 10px; touch-action: manipulation;
        }
        button:hover { opacity: 0.9; }
        .metronome-toggle-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding: 10px 0;
            border-top: 1px solid var(--color-panel-border);
            border-bottom: 1px solid var(--color-panel-border);
        }
        .metronome-toggle-label { font-size: 1em; color: var(--text-main); font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--color-panel-border); transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-accent); }
        input:checked + .slider:before { transform: translateX(26px); background-color: var(--bg-primary); }
        .light-mode input:checked + .slider:before { background-color: var(--bg-panel); }
        .swing-control { margin-bottom: 20px; padding-top: 5px; border-top: 1px solid var(--color-panel-border); }
        .swing-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .swing-text-label { font-size: 0.95em; color: var(--text-main); font-weight: bold; }
        .swing-percent { font-size: 1em; color: var(--text-main); font-weight: bold; }
        .swing-slider-container { position: relative; margin-bottom: 15px; }
        .swing-slider-container::after {
            content: ''; position: absolute; top: 50%; left: calc(67% - 3px); 
            transform: translate(-50%, -50%); width: 2px; height: 20px;
            background-color: var(--color-panel-border); pointer-events: none; z-index: 10;
        }
        .swing-slider-labels {
            display: flex; justify-content: space-between; font-size: 0.85em;
            color: var(--text-secondary); margin-top: -10px; margin-bottom: 15px;
        }
        .swing-buttons {
            display: flex; gap: 5px; background-color: var(--color-input-bg);
            border-radius: 6px; padding: 5px; margin-bottom: 15px;
        }
        .swing-btn {
            flex-grow: 1; padding: 8px 0; background-color: transparent;
            color: var(--text-secondary); font-size: 0.9em; font-weight: normal;
            border: none; transition: background-color 0.2s, color 0.2s; margin: 0; border-radius: 4px;
        }
        .swing-btn.active {
            background-color: var(--color-accent); color: var(--bg-primary);
            font-weight: bold; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .bpm-controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 10px; }
        .bpm-input-group { display: flex; align-items: center; gap: 0; width: 100%; border-radius: 6px; overflow: hidden; }
        .bpm-input-group button {
            width: 50px; padding: 10px 0; font-size: 1.5em; font-weight: normal;
            margin: 0; flex-shrink: 0; background-color: var(--bg-panel); 
            color: var(--text-main); border: none; transition: background-color 0.2s;
        }
        .bpm-input-group button:hover { background-color: var(--color-panel-border); }
        .bpm-input-group input {
            flex-grow: 1; text-align: center; font-size: 1.4em; font-weight: bold;
            padding: 8px 5px; margin: 0; border-radius: 0; background-color: var(--bg-panel);
            color: var(--text-main); border: none; min-width: 60px; box-sizing: border-box; 
        }
        #rhythm-tap-tempo-btn { margin-top: 0; background-color: var(--color-accent); color: var(--bg-primary); }
        label { display: block; margin-bottom: 8px; font-size: 0.95em; color: var(--text-secondary); }
        .meter-select, .theme-selector, .mode-selector {
            width: 100%; padding: 10px 10px; border-radius: 6px;
            border: 1px solid var(--color-panel-border); background-color: var(--color-input-bg);
            color: var(--text-main); font-size: 1em; text-align: left;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-repeat: no-repeat; background-position: right 10px top 50%;
            background-size: 10px; padding-right: 25px;
        }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; height: 6px;
            background: var(--color-panel-border); border-radius: 3px;
            outline: none; opacity: 1; transition: opacity .2s; margin: 10px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            border-radius: 50%; background: var(--color-accent); cursor: pointer;
        }
        .slider-text-labels {
            display: flex; justify-content: space-between; font-size: 0.85em;
            color: var(--text-secondary); margin-top: 5px;
        }
        .play-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .play-buttons button { flex: 1; margin-top: 0; }
        .pattern-display {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px;
            margin: 20px; align-items: flex-end;
            -webkit-overflow-scrolling: touch;
        }
        .beat-group {
            display: flex; flex-direction: column; align-items: center;
            position: relative; flex-shrink: 0; padding: 5px; 
        }
        .subdivision-group { display: flex; gap: 4px; margin-top: 10px; }
        .sub-beat {
            width: 18px; height: 18px; border-radius: 4px;
            background-color: var(--color-panel-border); cursor: pointer;
            transition: background-color 0.2s, width 0.1s, height 0.1s, border-radius 0.1s;
        }
        .sub-beat.active { background-color: var(--color-accent); }
        .sub-beat.sub-beat-3 { width: 12px; height: 12px; border-radius: 50%; background-color: var(--text-secondary); }
        .sub-beat.sub-beat-3.active { background-color: var(--color-indicator); }
        .sub-beat.current-16th { outline: 3px solid var(--color-indicator); outline-offset: 1px; }
        
        .sub-beat.downbeat-16th { 
            width: 22px; 
            height: 22px; 
            border-radius: 6px; 
            background-color: var(--color-panel-border); 
        }
        .sub-beat.downbeat-16th.sub-beat-3 { width: 16px; height: 16px; border-radius: 50%; }
        .sub-beat.downbeat-16th.active { background-color: var(--color-accent); }
        .sub-beat.downbeat-16th.sub-beat-3.active { background-color: var(--color-indicator); }

        .beat-marker {
            width: 100%; text-align: center; font-size: 0.9em;
            color: var(--text-secondary); margin-bottom: 5px; font-weight: bold;
            display:  none;
        }

        /* ========================================================= */
        /* === ê¸°íƒ€ ì§€íŒ ì‹œê°í™” CSS === */
        /* ========================================================= */
        
        #fretboard-collection {
            width: 100%; max-width: 1500px;
            flex-direction: column; gap: 30px; 
        }

        #combined-result-section {
            width: 100%; max-width: 1500px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 3px dashed var(--color-divider);
        }
        
        .fretboard-instance {
            background-color: var(--bg-panel); border-radius: 12px;
            padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%; position: relative; 
        }
        
        .header-action-buttons {
            display: flex; 
            gap: 8px; 
            position: absolute; 
            top: 15px; 
            right: 15px;
            z-index: 20;
        }
        .instance-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; 
            border-bottom: none; 
            padding-bottom: 0;
        }
        .instance-header h2 { margin: 0; font-size: 1.5em; color: var(--color-accent); }

        .fretboard-title-separator {
            border: 0;
            height: 1px;
            background-color: var(--color-panel-border); 
            margin: 0 0 20px 0;
        }
        
        .remove-fretboard-btn {
            background-color: transparent; 
            color: var(--text-secondary); border: 1px solid var(--color-panel-border); 
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-size: 0.75em; transition: all 0.2s; width: auto; z-index: 20; opacity: 0.8;
            margin-top:0px;
        }

        .fretboard-controls-panel { 
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            max-height: 1200px; overflow: hidden; opacity: 1; padding-top: 10px;
        }
        .fretboard-instance.compact-mode .fretboard-controls-panel {
            max-height: 0; opacity: 0; margin-bottom: 0; padding: 0;
        }
        
        .toggle-compact-btn {
            background-color: var(--color-input-bg); 
            color: var(--text-secondary); 
            border: 1px solid var(--color-panel-border); 
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-size: 0.75em; transition: all 0.2s; width: auto; opacity: 0.8;
            margin-top: 0; 
        }

        .fretboard-instance.compact-mode .toggle-compact-btn {
            background-color: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
            font-weight: bold;
            opacity: 1;
        }
        .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        
        .button-group button {
            background-color: #f8f9fa; 
            color: var(--text-main);
            border: 1px solid var(--color-panel-border); 
            padding: 8px 15px;
            font-size: 0.9em; font-weight: normal; margin-top: 0; width: auto; 
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .button-group button:hover { opacity: 0.9; }
        .button-group button.active {
            background-color: var(--color-accent); 
            color: white;
            border-color: var(--color-accent); 
            font-weight: normal; 
        }
        
        .color-mode-buttons button,
        .mode-type-buttons button {
            background-color: #f8f9fa;
            color: var(--text-main);
            border-color: var(--color-panel-border);
        }
        .color-mode-buttons button.active,
        .mode-type-buttons button.active {
             background-color: var(--color-accent);
             color: white;
             border-color: var(--color-accent);
        }

        .note-select-btn {
            background-color: #ffffff; color: var(--text-main);
            border: 2px solid var(--color-panel-border); min-width: 50px;
        }
        .note-select-btn.active { font-weight: bold; }

        .fretboard-display {
            width: 100%; overflow-x: hidden; 
            border: 2px solid #555; 
            border-radius: 4px; position: relative; height: 320px; 
            display: flex; flex-direction: column; 
        }
        .fretboard-row { display: flex; width: fit-content; position: relative; height: calc(100% / 8); }
        .number-row, .marker-row {
            height: calc(100% / 8); 
            min-height: 30px; 
            align-items: center; 
            font-size: 0.9em; 
            color: var(--text-secondary);
        }
        .number-row { border-top: none; border-bottom: 1px solid #000000;} 
        .marker-row { height: calc(100% / 8); min-height: 40px; }
        .string-row { border-bottom: 1px solid #000000; align-items: center; height: calc(100% / 8); }
        .string-row:last-child { border-bottom: none; }
        
        .fret-0-cell { 
            position: relative; height: 100%; flex-basis: var(--fret-0-width); 
            min-width: var(--fret-0-width); display: flex; justify-content: center;
            align-items: center; box-sizing: border-box; border-right: 3px solid #333; 
        }
        .fret-cell {
            position: relative; height: 100%; flex-basis: var(--fret-width); 
            min-width: var(--fret-width); display: flex; justify-content: center;
            align-items: center; box-sizing: border-box; border-right: 2px solid #333; 
        }
        .fretboard-row .fret-cell:nth-child(13) { border-right: 3px solid #333; }
        .fret-marker-dot {
            background: var(--dot-color); width: 8px; height: 8px;
            border-radius: 50%; z-index: 5; position: relative; 
        }
        .marker-cell.double-marker { flex-direction: column; gap: 2px; }
        
        .note-dot {
            width: 30px; height: 30px; border-radius: 50%; position: relative; 
            z-index: 10; display: flex; justify-content: center; align-items: center;
            color: black; font-weight: normal; font-size: 0.9em; cursor: default;
        }
        
        .note-dot.root {
            background-color: var(--color-highlight); 
            border: 2px solid #3567dc; 
            color: white; 
            z-index: 20;
        }
        
        /* [ìˆ˜ì •] ê¸°ë³¸ íšŒìƒ‰ ìŠ¤íƒ€ì¼ ì •ì˜ (ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •ë¨) */
        .note-dot.simple-other {
            background-color: var(--color-simple-other); 
            border: none; 
            color: var(--text-main); 
            font-weight: normal;
        }
        .note-dot.free-note { border: 1px solid var(--text-main); }
        
        .pattern-info {
            margin-top: 15px; margin-bottom: 20px; padding: 10px; 
            border: 1px solid var(--color-panel-border); border-radius: 8px; 
            background-color: var(--color-input-bg); color: var(--text-main);
        }
        .pattern-info strong { color: var(--color-accent); }
        .pattern-info span { font-family: sans-serif; font-size: 1.0em; margin-left: 10px; }
        
        .bottom-controls {
            margin-top: 15px; 
            display: flex; 
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }
        .bottom-controls button {
             padding: 8px 15px; border-radius: 6px; cursor: pointer;
             font-size: 0.9em; margin-top: 0; width: auto;
        }
        .clear-btn { background-color: #f0f0f0; border: 1px solid var(--color-divider); color: var(--text-main); }
        .toggle-compact-btn {
            background-color: #ffc107; color: #333; border: none;
        }

        .fretboard-section-header {
            margin-top: 50px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .add-fretboard-buttons {
            display: flex; gap: 15px; margin-top: 20px; margin-bottom: 20px;
            max-width: 1300px; width: 100%;
            justify-content: center; 
        }
        .add-fretboard-buttons button {
            padding: 15px 30px; font-size: 1.2em; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
            margin-top: 0; width: auto;
        }
        #fretboard-add-full-btn { background-color: var(--color-accent); color: white; }
        #fretboard-add-full-btn:hover { opacity: 0.9; }

        /* ========================================================= */
        /* === RESPONSIVE DESIGN === */
        /* ========================================================= */
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { margin-bottom: 20px; }
            h1 { font-size: 1.6em; }

            .top-container {
                flex-direction: column; 
                gap: 15px; 
                align-items: stretch;
            }
            
            .panel, .pattern-panel, .fretboard-instance {
                width: 100%;
                min-width: 0;
                padding: 15px; 
                box-sizing: border-box;
                margin-bottom: 0; 
            }

            h2 { font-size: 1.25em; margin-bottom: 15px; } 
            
            button {
                font-size: 1em; 
                padding: 10px 15px; 
            }
            
            .bpm-input-group input { font-size: 1.2em; }
            
            .metronome-toggle-label, .swing-text-label, .swing-percent { font-size: 0.9em; }
            
            label { font-size: 0.9em; }
            .meter-select { font-size: 0.95em; padding: 8px; }

            .pattern-display {
                margin: 10px 0;
                padding-bottom: 5px;
            }
            .sub-beat {
                width: 16px; height: 16px; 
            }
            
            .fretboard-display {
                overflow-x: auto !important; 
                -webkit-overflow-scrolling: touch; 
            }
            
            .fretboard-instance {
                display: flex;
                flex-direction: column;
            }
            
            .instance-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-top: 35px; 
            }
            .instance-header h2 { font-size: 1.3em; }
            
            .header-action-buttons {
                top: 15px;
                right: 15px;
                width: auto;
            }
            .header-action-buttons button {
                font-size: 0.8em;
                padding: 5px 10px;
            }

            .button-group button {
                padding: 8px 10px;
                font-size: 0.85em;
                flex-grow: 1; 
                justify-content: center;
                display: flex;
            }
            
            .root-note-buttons .root-btn {
                min-width: 35px;
                flex-grow: 0;
            }

            .slider-text-labels span { font-size: 0.75em; }
        }

        @media (max-width: 380px) {
            h1 { font-size: 1.4em; }
            .header-action-buttons button {
                padding: 4px 6px;
                font-size: 0.7em;
            }
            .panel { padding: 12px; }
        }

    </style>
</head>
<body>
    
    <div class="header">
        <h1 style="text-align: center;">ê¸°íƒ€ ë¿Œì‹œê¸°</h1>
    </div>

    <div class="top-container">
        <div class="panel">
            <h2>ë¦¬ë“¬ ìƒì„± ì„¤ì •</h2>
            <div class="setting-item">
                <label for="rhythm-time-signature-select">ë°•ì (Time Signature)</label>
                <select id="rhythm-time-signature-select" class="meter-select">
                    <option value="4/4">4/4 ë°•ì</option>
                    <option value="3/4">3/4 ë°•ì</option>
                    <option value="2/4">2/4 ë°•ì</option>
                    <option value="6/8">6/8 ë°•ì</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="rhythm-syncopation-range">ë‹¹ê¹€ìŒ(Syncopation) ë ˆë²¨: <span id="rhythm-syncopation-value">5</span></label>
                <input type="range" id="rhythm-syncopation-range" min="0" max="10" value="5">
                <div class="slider-text-labels">
                    <span>ì•½í•¨ (ì •ë°• ìœ„ì£¼)</span>
                    <span>ê°•í•¨ (ì—‡ë°• ìœ„ì£¼)</span>
                </div>
            </div>
            <div class="setting-item">
                <label for="rhythm-difficulty-range">ë‚œì´ë„ (16ë¶„ ìŒí‘œ ë¹ˆë„): <span id="rhythm-difficulty-value">5</span></label>
                <input type="range" id="rhythm-difficulty-range" min="0" max="10" value="5">
                <div class="slider-text-labels">
                    <span>ì‰¬ì›€ (ë‹¨ìˆœ)</span>
                    <span>ì–´ë ¤ì›€ (ë³µì¡)</span>
                </div>
            </div>
            <button id="rhythm-generate-btn">ë¦¬ë“¬ ìƒì„±</button>
        </div>

        <div class="panel">
            <h2>Tempo</h2>
            <div class="rhythm-bpm-controls bpm-controls">
                <div class="bpm-input-group">
                    <button id="rhythm-bpm-decrease">-</button>
                    <input type="number" id="rhythm-bpm-input" value="120" min="40" max="240">
                    <button id="rhythm-bpm-increase">+</button>
                </div>
                <button id="rhythm-tap-tempo-btn">Tap Tempo</button>
            </div>
            <div class="metronome-toggle-container">
                <span class="metronome-toggle-label">ë©”íŠ¸ë¡œë†ˆ ì¼œê¸°</span>
                <label class="switch">
                    <input type="checkbox" id="rhythm-metronome-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="swing-control">
                <div class="swing-label-row">
                    <span class="swing-text-label">Swing Amount</span>
                    <span class="swing-percent" id="rhythm-swing-percent-value">0%</span>
                </div>
                <div class="swing-slider-container">
                    <input type="range" id="rhythm-swing-amount" min="0" max="100" value="0">
                </div>
                <div class="swing-slider-labels">
                    <span>Straight (0%)</span>
                    <span>Triplet (67%)</span>
                    <span>Hard Swing (100%)</span>
                </div>
                <div class="swing-buttons" id="rhythm-swing-mode-buttons">
                    <button class="swing-btn active" data-swing-value="0">Straight</button>
                    <button class="swing-btn" data-swing-value="67">Triplet</button>
                    <button class="swing-btn" data-swing-value="100">Shuffle</button>
                </div>
            </div>
            <div class="play-buttons">
                <button id="rhythm-play-pause-btn">â–¶ Play</button>
            </div>
        </div>
    </div>

    <div class="pattern-panel">
        <h2 style="padding: 20px 20px 0 20px; margin-bottom: 0; border-bottom: none;">ìƒì„±ëœ ë¦¬ë“¬ íŒ¨í„´</h2>
        <div id="rhythm-pattern-display" class="pattern-display">
        </div>
    </div>

    <div class="fretboard-section-header">
        <h1>ê¸°íƒ€ ì§€íŒ ì‹œê°í™” ë„êµ¬</h1>
    </div>

    <div class="add-fretboard-buttons">
        <button id="fretboard-add-full-btn">ì…ë ¥ ì§€íŒ ì¶”ê°€ +</button>
    </div>

    <div id="fretboard-collection">
    </div>

    <div id="combined-result-section" style="display:none;">
        <div class="fretboard-instance">
            <div class="instance-header">
                <h2 style="color: var(--text-main);">ğŸ¸ í†µí•© ê²°ê³¼ ì§€íŒ (Combined Result)</h2>
            </div>
            <div id="combined-legend" class="pattern-info" style="margin-bottom: 20px;">
                <strong>ìƒ‰ìƒ ë²”ë¡€ (Color Legend):</strong> 
                <div id="legend-items" style="display: flex; flex-wrap: wrap; gap: 15px 30px; margin-top: 10px;">
                </div>
            </div>
            <div class="pattern-info">
                <strong>ì„¤ëª…:</strong> <span>ìœ„ì˜ ëª¨ë“  ì…ë ¥ ì§€íŒì´ í•©ì³ì ¸ì„œ ë³´ì…ë‹ˆë‹¤. (ë‹¤ì¤‘ ì†ŒìŠ¤ëŠ” ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ í‘œì‹œ)</span>
            </div>
            <div id="combined-fretboard-display" class="fretboard-display">
            </div>
        </div>
    </div>

    <template id="fretboard-template">
        <div class="fretboard-instance" id="fretboard-instance-0">
            <div class="header-action-buttons">
                <button class="toggle-compact-btn">Compact</button>
                <button class="remove-fretboard-btn">X ì œê±°</button>
            </div>
            <div class="instance-header">
                <h2 class="instance-title">ğŸ¸ ì…ë ¥ ì§€íŒ #0</h2>
            </div>
            <!-- <hr class="fretboard-title-separator"> -->

            <div class="fretboard-controls-panel">
                <div class="setting-item">
                    <label style="font-weight: bold;">ìƒ‰ìƒ í‘œì‹œ ëª¨ë“œ:</label>
                    <div class="button-group color-mode-buttons">
                        <button class="color-mode-btn active" data-mode="simple">ë£¨íŠ¸/ê¸°íƒ€(2ìƒ‰)</button>
                        <button class="color-mode-btn" data-mode="individual">ë¬´ì§€ê°œ(ê°œë³„)</button>
                    </div>
                </div>

                <div class="setting-item">
                    <label style="font-weight: bold;">íŒ¨í„´ ëª¨ë“œ ì„ íƒ:</label>
                    <div class="button-group mode-type-buttons">
                        <button class="mode-btn active" data-mode="scale">Scale</button>
                        <button class="mode-btn" data-mode="chord">Chord</button>
                        <button class="mode-btn" data-mode="free">Free Note</button>
                    </div>
                </div>

                <div class="control-group scale-controls">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">ê·¼ìŒ(Root Note) ì„ íƒ:</label>
                    <div class="button-group root-note-buttons horizontal-wrap">
                        <button class="root-btn active" data-root="C">C</button>
                        <button class="root-btn" data-root="C#">C#</button>
                        <button class="root-btn" data-root="Db">Db</button>
                        <button class="root-btn" data-root="D">D</button>
                        <button class="root-btn" data-root="D#">D#</button>
                        <button class="root-btn" data-root="Eb">Eb</button>
                        <button class="root-btn" data-root="E">E</button>
                        <button class="root-btn" data-root="F">F</button>
                        <button class="root-btn" data-root="F#">F#</button>
                        <button class="root-btn" data-root="Gb">Gb</button>
                        <button class="root-btn" data-root="G">G</button>
                        <button class="root-btn" data-root="G#">G#</button>
                        <button class="root-btn" data-root="Ab">Ab</button>
                        <button class="root-btn" data-root="A">A</button>
                        <button class="root-btn" data-root="A#">A#</button>
                        <button class="root-btn" data-root="Bb">Bb</button>
                        <button class="root-btn" data-root="B">B</button>
                    </div>
                    
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; margin-top: 15px;">ìŠ¤ì¼€ì¼ ì¢…ë¥˜ ì„ íƒ:</label>
                    <div class="button-group scale-type-buttons horizontal-wrap">
                        <button class="scale-btn active" data-scale="Major">Major</button>
                        <button class="scale-btn" data-scale="Natural Minor">Natural Minor</button>
                        <button class="scale-btn" data-scale="Harmonic Minor">Harmonic Minor</button>
                        <button class="scale-btn" data-scale="Melodic Minor">Melodic Minor</button>
                        <button class="scale-btn" data-scale="Pentatonic Major">Pent. Major</button>
                        <button class="scale-btn" data-scale="Pentatonic Minor">Pent. Minor</button>
                        <button class="scale-btn" data-scale="Blues">Blues</button>
                        <button class="scale-btn" data-scale="Dorian">Dorian</button>
                        <button class="scale-btn" data-scale="Phrygian">Phrygian</button>
                        <button class="scale-btn" data-scale="Lydian">Lydian</button>
                        <button class="scale-btn" data-scale="Mixolydian">Mixolydian</button>
                        <button class="scale-btn" data-scale="Locrian">Locrian</button>
                        <button class="scale-btn" data-scale="Whole Tone">Whole Tone</button>
                        <button class="scale-btn" data-scale="Diminished">Diminished</button>
                        <button class="scale-btn" data-scale="Hungarian Minor">Hungarian Minor</button>
                        <button class="scale-btn" data-scale="Persian">Persian</button>
                    </div>
                </div>

                <div class="control-group chord-controls" style="display:none;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">ê·¼ìŒ(Root Note) ì„ íƒ:</label>
                    <div class="button-group root-note-buttons horizontal-wrap">
                        <button class="root-btn active" data-root="C">C</button>
                        <button class="root-btn" data-root="C#">C#</button>
                        <button class="root-btn" data-root="Db">Db</button>
                        <button class="root-btn" data-root="D">D</button>
                        <button class="root-btn" data-root="D#">D#</button>
                        <button class="root-btn" data-root="Eb">Eb</button>
                        <button class="root-btn" data-root="E">E</button>
                        <button class="root-btn" data-root="F">F</button>
                        <button class="root-btn" data-root="F#">F#</button>
                        <button class="root-btn" data-root="Gb">Gb</button>
                        <button class="root-btn" data-root="G">G</button>
                        <button class="root-btn" data-root="G#">G#</button>
                        <button class="root-btn" data-root="Ab">Ab</button>
                        <button class="root-btn" data-root="A">A</button>
                        <button class="root-btn" data-root="A#">A#</button>
                        <button class="root-btn" data-root="Bb">Bb</button>
                        <button class="root-btn" data-root="B">B</button>
                    </div>
                    
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; margin-top: 15px;">ì½”ë“œ ì¢…ë¥˜ ì„ íƒ:</label>
                    <div class="button-group chord-type-buttons horizontal-wrap">
                        <button class="chord-btn active" data-chord="Major">Major (M)</button>
                        <button class="chord-btn" data-chord="Minor">Minor (m)</button>
                        <button class="chord-btn" data-chord="Dominant 7th">Dominant 7th (7)</button>
                        <button class="chord-btn" data-chord="Major 7th">Major 7th (M7)</button>
                        <button class="chord-btn" data-chord="Minor 7th">Minor 7th (m7)</button>
                        <button class="chord-btn" data-chord="Diminished">Diminished (dim)</button>
                        <button class="chord-btn" data-chord="Augmented">Augmented (aug)</button>
                        <button class="chord-btn" data-chord="Sus4">Sus4 (sus4)</button>
                        <button class="chord-btn" data-chord="Add9">Add9 (add9)</button>
                        <button class="chord-btn" data-chord="Major 9th">Major 9th (M9)</button>
                        <button class="chord-btn" data-chord="Minor 9th">Minor 9th (m9)</button>
                        <button class="chord-btn" data-chord="Dominant 9th">Dominant 9th (9)</button>
                    </div>
                </div>

                <div class="control-group free-note-controls" style="display:none;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">í‘œì‹œí•  ìŒ ì„ íƒ:</label>
                    <div class="button-group free-note-buttons horizontal-wrap">
                        </div>
                    <div class="bottom-controls">
                        <button class="clear-free-notes-btn">ëª¨ë‘ í•´ì œ</button>
                    </div>
                </div>
                
                <hr class="fretboard-title-separator" style="margin-top: 20px;">
                
                <div class="setting-item">
                    <label style="font-weight: bold;">í‘œì‹œ í…ìŠ¤íŠ¸ ëª¨ë“œ:</label>
                    <div class="button-group display-mode-buttons">
                        <button class="display-mode-btn active" data-mode="note">ìŒì´ë¦„</button>
                        <button class="display-mode-btn" data-mode="degree">ìŒì •(ë„ìˆ˜)</button>
                    </div>
                </div>
            </div>

            <div class="pattern-info">
                <strong>íŒ¨í„´ ì •ë³´:</strong> <span class="pattern-info-span">C Major Scale</span>
            </div>

            <div class="fretboard-display">
                </div>
        </div>
    </template>

    <script>
        // DOM Elements
        const rhythmPlayPauseBtn = document.getElementById('rhythm-play-pause-btn');
        const rhythmBPMInput = document.getElementById('rhythm-bpm-input');
        const rhythmBPMIncreaseBtn = document.getElementById('rhythm-bpm-increase');
        const rhythmBPMDecreaseBtn = document.getElementById('rhythm-bpm-decrease');
        const rhythmGenerateBtn = document.getElementById('rhythm-generate-btn');
        const rhythmTapTempoBtn = document.getElementById('rhythm-tap-tempo-btn');
        const rhythmMetronomeToggle = document.getElementById('rhythm-metronome-toggle');
        const rhythmTimeSignatureSelect = document.getElementById('rhythm-time-signature-select');
        const rhythmSwingRange = document.getElementById('rhythm-swing-amount');
        const rhythmSwingPercentValue = document.getElementById('rhythm-swing-percent-value');
        const rhythmSwingButtonsContainer = document.getElementById('rhythm-swing-mode-buttons');
        const rhythmPatternDisplay = document.getElementById('rhythm-pattern-display');
        const rhythmSyncopationRange = document.getElementById('rhythm-syncopation-range');
        const rhythmDifficultyRange = document.getElementById('rhythm-difficulty-range');

        const fretboardCollection = document.getElementById('fretboard-collection');
        const fretboardAddFullBtn = document.getElementById('fretboard-add-full-btn');
        const combinedResultDisplay = document.getElementById('combined-fretboard-display');
        const combinedResultSection = document.getElementById('combined-result-section');
        const fretboardTemplate = document.getElementById('fretboard-template');

        // Rhythm Station Variables
        let rhythmBPM = 120;
        let rhythmIsPlaying = false;
        let rhythmCurrentBeat = 0;
        let rhythmNextNoteTime = 0.0;
        let rhythmScheduleAheadTime = 0.1; // seconds
        let rhythmTimerId = null;
        let rhythmAudioContext = null;
        let rhythmAudioContextInitialized = false;
        let rhythmTimeSignature = '4/4';
        let rhythmBeatsPerMeasure = 4;
        let rhythmSubdivision = 4; // 4 = 16th notes, 3 = triplets (8th note triplets)
        let rhythmSyncopationLevel = 5;
        let rhythmDifficultyLevel = 5;
        let rhythmSwingAmount = 0;
        let rhythmPattern = [];
        let rhythmIsMetronomeAlwaysOn = true;
        let rhythmMetronomeOscillator = null;
        let rhythmMetronomeGain = null;
        let rhythmAddHighlightSchedule = [];
        let rhythmRemoveHighlightSchedule = [];
        
        // Tap Tempo ë³€ìˆ˜
        let rhythmTapTimes = []; 
        const rhythmTapTimeMax = 4; 

        function rhythmInitAudio() {
            if (rhythmAudioContextInitialized) {
                if (rhythmAudioContext && rhythmAudioContext.state === 'suspended') {
                    rhythmAudioContext.resume().catch(e => console.error("AudioContext resume failed:", e));
                }
                return;
            }
            
            rhythmAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (rhythmAudioContext.state === 'suspended') {
                rhythmAudioContext.resume().catch(e => console.error("Initial AudioContext resume failed:", e));
            }

            rhythmMetronomeOscillator = rhythmAudioContext.createOscillator();
            rhythmMetronomeOscillator.type = 'square';
            rhythmMetronomeOscillator.frequency.setValueAtTime(440, 0);
            rhythmMetronomeOscillator.start(0);
            
            rhythmMetronomeGain = rhythmAudioContext.createGain();
            rhythmMetronomeGain.gain.setValueAtTime(0, 0);
            
            rhythmMetronomeOscillator.connect(rhythmMetronomeGain);
            rhythmMetronomeGain.connect(rhythmAudioContext.destination);
            rhythmAudioContextInitialized = true;
        }
        
        function rhythmPlaySound(time, frequency, volume) {
            if (!rhythmAudioContextInitialized) return;

            const oscillator = rhythmAudioContext.createOscillator();
            const gainNode = rhythmAudioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(rhythmAudioContext.destination);

            oscillator.frequency.setValueAtTime(frequency, time);
            gainNode.gain.setValueAtTime(volume, time);
            
            gainNode.gain.exponentialRampToValueAtTime(0.0001, time + 0.03); 

            oscillator.start(time);
            oscillator.stop(time + 0.03); 
        }

        function rhythmScheduler() {
            if (!rhythmAudioContextInitialized || !rhythmIsPlaying) return;

            while (rhythmNextNoteTime < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const secondsPerBeat = 60.0 / rhythmBPM;
                rhythmScheduleNote(rhythmCurrentBeat, rhythmNextNoteTime);
                
                rhythmNextNoteTime += secondsPerBeat;
                rhythmCurrentBeat = (rhythmCurrentBeat + 1) % rhythmBeatsPerMeasure;
            }

            while (rhythmRemoveHighlightSchedule.length > 0 && rhythmRemoveHighlightSchedule[0].time < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const remove = rhythmRemoveHighlightSchedule.shift();
                const targetElement = document.querySelector(`.sub-beat[data-sub-beat-index="${remove.index}"]`);
                if (targetElement) targetElement.classList.remove('current-16th');
            }

            while (rhythmAddHighlightSchedule.length > 0 && rhythmAddHighlightSchedule[0].time < rhythmAudioContext.currentTime + rhythmScheduleAheadTime) {
                const highlight = rhythmAddHighlightSchedule.shift();
                const currentSubBeat = document.querySelector(`.sub-beat[data-sub-beat-index="${highlight.index}"]`);
                if (currentSubBeat) currentSubBeat.classList.add('current-16th');
            }

            rhythmTimerId = window.setTimeout(rhythmScheduler, 25.0);
        }

        function rhythmScheduleNote(beatNumber, scheduledTime) {
            if (!rhythmAudioContextInitialized) return;
            
            const secondsPerBeat = 60.0 / rhythmBPM;
            const subBeatDuration = secondsPerBeat / rhythmSubdivision;
            const measureIndex = beatNumber * rhythmSubdivision;
            
            for (let i = 0; i < rhythmSubdivision; i++) {
                const patternIndex = measureIndex + i;
                const isBeatOne = (beatNumber === 0 && i === 0); 
                const isDownBeat = (i === 0); 
                
                let timeOffset = 0;
                if (rhythmSwingAmount > 0 && rhythmSubdivision === 4) {
                    if (i % 2 !== 0) { 
                        const swingRatio = rhythmSwingAmount / 100.0; 
                        const swingFactor = 2 * (1 - swingRatio); 
                        const straightDuration = secondsPerBeat / 2; 
                        timeOffset = straightDuration * (swingFactor - 1);
                    }
                }

                const subBeatTime = scheduledTime + (i * subBeatDuration) + timeOffset;

                const isPatternActive = rhythmPattern[patternIndex % rhythmPattern.length];
                
                if (isPatternActive || (rhythmIsMetronomeAlwaysOn && isDownBeat)) {
                    // [ìˆ˜ì •ëœ ë¡œì§]
                    // 1. frequencyì™€ volume ë³€ìˆ˜ë¥¼ ì„ ì–¸ë§Œ í•˜ê³ , ì´ˆê¸°ê°’ì€ ì•„ë˜ if/else ë¸”ë¡ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
                    let frequency; 
                    let volume;

                    if (isPatternActive) {
                        // 2. íŒ¨í„´ì´ í™œì„±í™” ëœ ê²½ìš° (íŒ¨í„´ ì†Œë¦¬ê°€ ìš°ì„ )
                        if (isDownBeat) {
                            // ì •ë°•(Downbeat: 1, 2, 3, 4)ì´ í™œì„±í™” ë¨ -> ê°•í•œ ì†Œë¦¬ (ì²« ë°• ì†Œë¦¬ì²˜ëŸ¼)
                            frequency = 700; 
                            volume = 1.0;
                        } else {
                            // ì—‡ë°•(Off-beat)ì´ í™œì„±í™” ë¨ -> ë‚®ì€ ì†Œë¦¬ (ë² ì´ìŠ¤ í‚¥ ëŠë‚Œ)
                            frequency = 220;
                            volume = 0.5;
                        }
                    } else {
                        // íŒ¨í„´ ë¹„í™œì„±í™” ìƒíƒœ (ë©”íŠ¸ë¡œë†ˆë§Œ ë“¤ë¦´ ë•Œ)
                        if (isBeatOne) {
                            // ğŸ¶ ìš”ì²­ ì‚¬í•­ ë°˜ì˜: ì²« ë°•ì´ íŒ¨í„´ ë¹„í™œì„±í™” ìƒíƒœì´ë©´ ë‚®ì€ ì†Œë¦¬ (220Hz)
                            frequency = 220; 
                        } else {
                            // ê·¸ ì™¸ ì •ë°• (2, 3, 4)ì€ ê¸°ë³¸ ë©”íŠ¸ë¡œë†ˆ ì†Œë¦¬ (440Hz)
                            frequency = 440;
                        }
                        volume = 0.8; // ê¸°ë³¸ ë©”íŠ¸ë¡œë†ˆ ë³¼ë¥¨
                    }
                    
                    rhythmPlaySound(subBeatTime, frequency, volume);
                }
                
                rhythmAddHighlightSchedule.push({ time: subBeatTime, index: patternIndex % rhythmPattern.length });
                rhythmRemoveHighlightSchedule.push({ time: subBeatTime + subBeatDuration, index: patternIndex % rhythmPattern.length });
            }
        }

        function rhythmGenerateRhythm() {
            rhythmSyncopationLevel = parseInt(rhythmSyncopationRange.value);
            rhythmDifficultyLevel = parseInt(rhythmDifficultyRange.value);
            const total16thNotes = rhythmBeatsPerMeasure * rhythmSubdivision;
            rhythmPattern = new Array(total16thNotes).fill(0);

            for(let i=0; i < total16thNotes; i++) {
                 if (i % rhythmSubdivision === 0) { 
                    rhythmPattern[i] = 1;
                 } else { 
                    if (Math.random() < rhythmSyncopationLevel * 0.05 + rhythmDifficultyLevel * 0.02) {
                        rhythmPattern[i] = 1;
                    }
                 }
            }

            rhythmDisplayPattern(rhythmPattern);
            rhythmInitAudio(); 
        }

        function rhythmTogglePlayPause() {
            rhythmInitAudio(); 
            if (rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
            
            if (rhythmIsPlaying) {
                window.clearTimeout(rhythmTimerId);
                rhythmIsPlaying = false;
                rhythmPlayPauseBtn.textContent = "â–¶ Play";
                rhythmRemoveAllHighlights();
                rhythmAddHighlightSchedule = [];
                rhythmRemoveHighlightSchedule = [];
            } else {
                rhythmIsPlaying = true;
                rhythmPlayPauseBtn.textContent = "âšâš Pause";
                rhythmNextNoteTime = rhythmAudioContext.currentTime;
                rhythmCurrentBeat = 0;
                rhythmScheduler();
            }
        }

        function rhythmUpdateBPM(newBPM) {
            rhythmBPM = Math.max(40, Math.min(240, newBPM));
            rhythmBPMInput.value = rhythmBPM;
        }

        function rhythmIncreaseBPM() { rhythmUpdateBPM(rhythmBPM + 1); }
        function rhythmDecreaseBPM() { rhythmUpdateBPM(rhythmBPM - 1); }

        function rhythmHandleTapTempo() {
            rhythmInitAudio(); 
            if (rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();

            const now = rhythmAudioContext.currentTime * 1000; 

            if (rhythmTapTimes.length > 0 && (now - rhythmTapTimes[rhythmTapTimes.length - 1] > 2000)) {
                rhythmTapTimes = [now];
                return;
            }

            rhythmTapTimes.push(now);

            if (rhythmTapTimes.length > rhythmTapTimeMax) {
                rhythmTapTimes.shift(); 
            }

            if (rhythmTapTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < rhythmTapTimes.length; i++) {
                    intervals.push(rhythmTapTimes[i] - rhythmTapTimes[i-1]);
                }
                
                const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const newBPM = Math.round(60000 / averageInterval);
                rhythmUpdateBPM(newBPM);
            }
        }

        function rhythmHandleSwingSelection(value) {
            rhythmSwingAmount = Math.max(0, Math.min(100, parseInt(value)));
            rhythmSwingRange.value = rhythmSwingAmount;
            rhythmSwingPercentValue.textContent = `${rhythmSwingAmount}%`;
            rhythmSwingButtonsContainer.querySelectorAll('.swing-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.swingValue) === rhythmSwingAmount) btn.classList.add('active');
            });
        }

        function rhythmHandleSwingButtonEvent(e) {
            const btn = e.target.closest('.swing-btn');
            if (btn) rhythmHandleSwingSelection(btn.dataset.swingValue);
        }

        function rhythmHandleSwingSliderEvent(e) {
            rhythmHandleSwingSelection(e.target.value);
        }

        function rhythmRemoveAllHighlights() {
            document.querySelectorAll('.sub-beat').forEach(b => b.classList.remove('current-16th'));
            document.querySelectorAll('.beat-group').forEach(b => b.classList.remove('highlight-current-beat'));
        }

        function rhythmDisplayPattern(pattern) {
            rhythmPatternDisplay.innerHTML = '';
            
            for (let i = 0; i < rhythmBeatsPerMeasure; i++) {
                const beatGroup = document.createElement('div');
                beatGroup.className = 'beat-group';
                beatGroup.dataset.beatIndex = i;

                const beatMarker = document.createElement('div');
                beatMarker.className = 'beat-marker';
                beatMarker.textContent = i + 1;
                beatGroup.appendChild(beatMarker);

                const subdivisionGroup = document.createElement('div');
                subdivisionGroup.className = 'subdivision-group';
                
                for (let j = 0; j < rhythmSubdivision; j++) {
                    const patternIndex = (i * rhythmSubdivision) + j;
                    const subBeat = document.createElement('div');
                    subBeat.className = `sub-beat ${rhythmSubdivision === 3 ? 'sub-beat-3' : ''}`;
                    
                    if (j === 0) { 
                        subBeat.classList.add('downbeat-16th');
                    }
                    
                    subBeat.dataset.subBeatIndex = patternIndex;
                    subBeat.dataset.beat = i + 1;
                    subBeat.dataset.sub = j + 1;
                    if (pattern[patternIndex] === 1) subBeat.classList.add('active');
                    
                    subBeat.addEventListener('click', () => {
                        rhythmInitAudio(); 
                        if (rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
                        
                        pattern[patternIndex] = pattern[patternIndex] === 1 ? 0 : 1;
                        subBeat.classList.toggle('active');
                    });
                    
                    subBeat.addEventListener('touchstart', (e) => {
                        e.preventDefault(); 
                        rhythmInitAudio(); 
                        if (rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
                    });

                    subdivisionGroup.appendChild(subBeat);
                }
                beatGroup.appendChild(subdivisionGroup);
                rhythmPatternDisplay.appendChild(beatGroup);
            }
        }

        function rhythmUpdateTheme(selectedTheme, selectedMode) {
            const body = document.body;
            body.classList.remove('dark-mode', 'light-mode');
            body.classList.remove('theme-blue');
            body.classList.add(`theme-${selectedTheme}`);
            if (selectedMode === 'light') body.classList.add('light-mode');
            else body.classList.add('dark-mode');
        }

        // Event Listeners (ëª¨ë°”ì¼ ì˜¤ë””ì˜¤ë¥¼ ìœ„í•´ touchstart ì¶”ê°€)
        rhythmPlayPauseBtn.addEventListener('click', rhythmTogglePlayPause);
        rhythmPlayPauseBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            rhythmTogglePlayPause();
        });

        rhythmBPMIncreaseBtn.addEventListener('click', rhythmIncreaseBPM);
        rhythmBPMDecreaseBtn.addEventListener('click', rhythmDecreaseBPM);
        
        rhythmGenerateBtn.addEventListener('click', () => {
            rhythmInitAudio();
            if (rhythmAudioContext && rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
            rhythmGenerateRhythm();
        });
        rhythmGenerateBtn.addEventListener('touchstart', () => {
             rhythmInitAudio();
             if (rhythmAudioContext && rhythmAudioContext.state === 'suspended') rhythmAudioContext.resume();
        });
        
        rhythmTapTempoBtn.addEventListener('click', rhythmHandleTapTempo);
        rhythmTapTempoBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            rhythmHandleTapTempo();
        });

        rhythmMetronomeToggle.addEventListener('change', (e) => {
            rhythmIsMetronomeAlwaysOn = e.target.checked;
            rhythmInitAudio(); 
        });

        rhythmBPMInput.addEventListener('change', (e) => {
            rhythmUpdateBPM(parseInt(e.target.value));
            if (rhythmIsPlaying) {
                rhythmTogglePlayPause();
                rhythmTogglePlayPause();
            }
            rhythmInitAudio(); 
        });

        rhythmSwingButtonsContainer.addEventListener('click', rhythmHandleSwingButtonEvent);
        rhythmSwingRange.addEventListener('input', rhythmHandleSwingSliderEvent);
        rhythmSwingRange.addEventListener('change', rhythmHandleSwingSliderEvent);

        rhythmTimeSignatureSelect.addEventListener('change', (e) => {
            rhythmTimeSignature = e.target.value;
            const [numerator, denominator] = rhythmTimeSignature.split('/').map(Number);
            rhythmBeatsPerMeasure = numerator;
            rhythmSubdivision = (denominator === 8) ? 3 : 4;
            rhythmGenerateRhythm();
        });
        
        rhythmSyncopationRange.addEventListener('input', (e) => {
            document.getElementById('rhythm-syncopation-value').textContent = e.target.value;
        });
        
        rhythmDifficultyRange.addEventListener('input', (e) => {
            document.getElementById('rhythm-difficulty-value').textContent = e.target.value;
        });

        // =========================================================
        // === FRETBOARD VISUALIZER ===
        // =========================================================

        const fretboardTotalFrets = 24; 
        const fretboardOpenStrings = [4, 9, 2, 7, 11, 4]; // E A D G B E
        const fretboardSharpNoteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const fretboardFlatNoteNames = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const fretboardNoteIndices = { "C": 0, "C#": 1, "Db": 1, "D": 2, "D#": 3, "Eb": 3, "E": 4, "F": 5, "F#": 6, "Gb": 6, "G": 7, "G#": 8, "Ab": 8, "A": 9, "A#": 10, "Bb": 10, "B": 11 };
        const fretboardFlatRoots = ["Db", "Eb", "Gb", "Ab", "Bb", "F"]; 

        // íŒŒìŠ¤í…”í†¤ ê°œë³„ ìŒ ìƒ‰ìƒ (Pastel Tones for 'individual' mode)
        const fretboardNoteColors = {
            0: "#ADD8E6", // C - Light Blue
            1: "#B0E0E6", // C#/Db - Powder Blue
            2: "#F0E68C", // D - Light Khaki
            3: "#F8F8FF", // D#/Eb - Ghost White
            4: "#98FB98", // E - Pale Green
            5: "#DDA0DD", // F - Plum
            6: "#FFDAB9", // F#/Gb - Peach Puff
            7: "#FFB347", // G - Pastel Orange
            8: "#FF6961", // G#/Ab - Light Coral
            9: "#FFC0CB", // A - Pink
            10: "#AEC6E6", // A#/Bb - Light Blue
            11: "#C6AEC7"  // B - Pastel Lavender
        };
        
        const fretboardFunctionalDegreeNames = { 
            0: "R", 1: "b2", 2: "2", 3: "b3", 4: "3", 5: "4", 6: "#4/b5", 7: "5", 8: "b6", 9: "6", 10: "b7", 11: "7" 
        };
        const fretboardSCALE_INTERVALS = {
            "Major": [0, 2, 4, 5, 7, 9, 11],
            "Natural Minor": [0, 2, 3, 5, 7, 8, 10],
            "Harmonic Minor": [0, 2, 3, 5, 7, 8, 11],
            "Melodic Minor": [0, 2, 3, 5, 7, 9, 11],
            "Pentatonic Major": [0, 2, 4, 7, 9],
            "Pentatonic Minor": [0, 3, 5, 7, 10],
            "Blues": [0, 3, 5, 6, 7, 10],
            "Dorian": [0, 2, 3, 5, 7, 9, 10],
            "Phrygian": [0, 1, 3, 5, 7, 8, 10],
            "Lydian": [0, 2, 4, 6, 7, 9, 11],
            "Mixolydian": [0, 2, 4, 5, 7, 9, 10],
            "Locrian": [0, 1, 3, 5, 6, 8, 10],
            "Whole Tone": [0, 2, 4, 6, 8, 10],
            "Diminished": [0, 2, 3, 5, 6, 8, 9, 11],
            "Hungarian Minor": [0, 2, 3, 6, 7, 8, 11],
            "Persian": [0, 1, 4, 5, 6, 8, 11]
        };
        const fretboardCHORD_INTERVALS = {
            "Major": [0, 4, 7],
            "Minor": [0, 3, 7],
            "Dominant 7th": [0, 4, 7, 10],
            "Major 7th": [0, 4, 7, 11],
            "Minor 7th": [0, 3, 7, 10],
            "Diminished": [0, 3, 6],
            "Augmented": [0, 4, 8],
            "Sus4": [0, 5, 7],
            "Add9": [0, 4, 7, 2],
            "Major 9th": [0, 4, 7, 11, 2],
            "Minor 9th": [0, 3, 7, 10, 2],
            "Dominant 9th": [0, 4, 7, 10, 2]
        };

        let fretboardInstances = {};
        let fretboardNextId = 1;

        // Fretboard Utility Functions
        function fretboardGetPatternIntervals(patternMode, patternType) {
            if (patternMode === 'scale') return fretboardSCALE_INTERVALS[patternType] || [];
            if (patternMode === 'chord') return fretboardCHORD_INTERVALS[patternType] || [];
            return [];
        }

        function fretboardGetPatternDegreeName(interval, patternType) {
            if (patternType.includes("Major") && interval === 11) return "7"; 
            if (patternType.includes("Minor") && interval === 10) return "b7"; 
            if (interval === 1) return "b2";
            if (interval === 3) return "b3";
            if (interval === 6) return "#4/b5";
            if (interval === 8) return "b6";
            if (interval === 10) return "b7";
            return fretboardFunctionalDegreeNames[interval] || '';
        }

        function renderFretboardGrid(container, getDotContentCallback) {
            // 1. Number Row
            const numberRow = document.createElement('div');
            numberRow.className = 'fretboard-row number-row';
            numberRow.appendChild(document.createElement('div')).className = 'fret-0-cell';

            // 2. Marker Row
            const markerRow = document.createElement('div');
            markerRow.className = 'fretboard-row marker-row';
            markerRow.appendChild(document.createElement('div')).className = 'fret-0-cell';
            container.appendChild(numberRow);
            for (let f = 1; f <= fretboardTotalFrets; f++) {
                const numberCell = document.createElement('div');
                numberCell.className = 'fret-cell';
                numberCell.textContent = f;
                numberRow.appendChild(numberCell);

                const markerCell = document.createElement('div');
                markerCell.className = 'fret-cell marker-cell';
                if ([3,5,7,9,15,17,19,21].includes(f)) markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                else if ([12,24].includes(f)) { 
                    markerCell.classList.add('double-marker');
                    markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                    markerCell.appendChild(document.createElement('div')).className = 'fret-marker-dot';
                }
                markerRow.appendChild(markerCell);
            }

            for (let s = 0; s < fretboardOpenStrings.length; s++) {
                const stringRow = document.createElement('div');
                stringRow.className = 'fretboard-row string-row';

                let dotDiv = getDotContentCallback(s, 0);
                const fret0Cell = document.createElement('div');
                fret0Cell.className = 'fret-0-cell fret-space';
                if (dotDiv) fret0Cell.appendChild(dotDiv);
                stringRow.appendChild(fret0Cell);

                for (let f = 1; f <= fretboardTotalFrets; f++) {
                    dotDiv = getDotContentCallback(s, f);
                    const fretCell = document.createElement('div');
                    fretCell.className = 'fret-cell fret-space';
                    if (dotDiv) fretCell.appendChild(dotDiv);
                    stringRow.appendChild(fretCell);
                }
                container.appendChild(stringRow);
            }
            
            
            container.appendChild(markerRow);
        }

        // [FRETBOARD] CLASS DEFINITION
        class FretboardInstance {
            constructor(id) {
                this.id = id;
                this.patternMode = 'scale';
                this.scaleType = 'Major';
                this.chordType = 'Major';
                this.rootNote = 'C';
                this.displayMode = 'note';
                this.colorMode = 'simple'; // Default color mode
                this.selectedFreeNotes = new Set();
                
                this.rootElement = fretboardTemplate.content.cloneNode(true).querySelector('.fretboard-instance');
                this.rootElement.id = `fretboard-instance-${id}`;
                
                this.dom = {
                    root: this.rootElement,
                    instanceTitle: this.rootElement.querySelector('.instance-title'),
                    removeBtn: this.rootElement.querySelector('.remove-fretboard-btn'),
                    toggleCompactBtn: this.rootElement.querySelector('.toggle-compact-btn'),
                    
                    colorModeButtons: this.rootElement.querySelector('.color-mode-buttons'),
                    modeTypeButtons: this.rootElement.querySelector('.mode-type-buttons'),
                    displayModeButtons: this.rootElement.querySelector('.display-mode-buttons'),

                    scaleControls: this.rootElement.querySelector('.scale-controls'),
                    chordControls: this.rootElement.querySelector('.chord-controls'),
                    freeNoteControls: this.rootElement.querySelector('.free-note-controls'),
                    
                    scaleRootNoteButtons: this.rootElement.querySelector('.scale-controls .root-note-buttons'),
                    scaleTypeButtons: this.rootElement.querySelector('.scale-type-buttons'),
                    
                    chordRootNoteButtons: this.rootElement.querySelector('.chord-controls .root-note-buttons'),
                    chordTypeButtons: this.rootElement.querySelector('.chord-type-buttons'),
                    
                    freeNoteButtonsContainer: this.rootElement.querySelector('.free-note-buttons'),
                    clearFreeNotesBtn: this.rootElement.querySelector('.clear-free-notes-btn'),
                    
                    patternInfoSpan: this.rootElement.querySelector('.pattern-info-span'),
                    fretboardDisplay: this.rootElement.querySelector('.fretboard-display'),
                };
                
                this.dom.instanceTitle.textContent = `ğŸ¸ ì…ë ¥ ì§€íŒ #${id}`;

                this.setupInitialState();
                this.setupEventListeners();
                fretboardInstances[id] = this;
            }

            setupInitialState() {
                this.renderFreeNoteButtons();
                this.renderCurrentPattern();
            }

            toggleCompactMode(shouldCompact) {
                if (shouldCompact) {
                    this.dom.root.classList.add('compact-mode');
                    this.dom.toggleCompactBtn.textContent = 'Expand';
                } else {
                    this.dom.root.classList.remove('compact-mode');
                    this.dom.toggleCompactBtn.textContent = 'Compact';
                }
            }

            renderFreeNoteButtons() {
                const container = this.dom.freeNoteButtonsContainer;
                container.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const button = document.createElement('button');
                    const useFlat = fretboardFlatRoots.includes(this.rootNote);
                    button.textContent = useFlat ? fretboardFlatNoteNames[i] : fretboardSharpNoteNames[i];
                    button.className = 'note-select-btn';
                    button.dataset.noteIndex = i;
                    if (this.selectedFreeNotes.has(i)) button.classList.add('active');
                    container.appendChild(button);
                }
            }

            getPatternTitle() {
                const isScale = this.patternMode === 'scale';
                const pattern = isScale ? this.scaleType : (this.chordType === 'Major' ? '' : this.chordType);
                const type = isScale ? 'Scale' : 'Chord';
                return this.rootNote + ' ' + pattern + (this.patternMode === 'free' ? ' (ì„ íƒ ìŒ)' : ' ' + type);
            }

            generatePatternData() {
                const isScale = this.patternMode === 'scale';
                const type = isScale ? this.scaleType : this.chordType;
                return {
                    patternType: this.patternMode,
                    scaleType: isScale ? this.scaleType : null,
                    chordType: isScale ? null : this.chordType,
                    rootNote: this.rootNote,
                    rootIndex: fretboardNoteIndices[this.rootNote],
                    intervals: this.patternMode === 'free' ? [] : fretboardGetPatternIntervals(this.patternMode, type),
                    selectedFreeNotes: this.selectedFreeNotes,
                };
            }

            getNoteLabelAndClass(noteIndex, patternIntervals) {
                const rootIndex = fretboardNoteIndices[this.rootNote];
                let interval = (noteIndex - rootIndex + 12) % 12;
                let label, cssClass = '';

                if (this.displayMode === 'note') {
                    const useFlat = fretboardFlatRoots.includes(this.rootNote);
                    label = useFlat ? fretboardFlatNoteNames[noteIndex] : fretboardSharpNoteNames[noteIndex];
                } else {
                    if (this.patternMode === 'free') label = 'â—‰';
                    else label = fretboardGetPatternDegreeName(interval, this.patternMode === 'scale' ? this.scaleType : this.chordType);
                }

                // [ìˆ˜ì •] ê¸°íƒ€ ìŒì„ simple-other í´ë˜ìŠ¤ë¡œ ë§¤í•‘í•˜ì—¬ CSS ë³€ìˆ˜ ìƒ‰ìƒ ì ìš©
                if (interval === 0 && this.patternMode !== 'free') cssClass = 'root';
                else if (patternIntervals.includes(interval)) cssClass = 'simple-other';
                else if (this.patternMode === 'free' && this.selectedFreeNotes.has(noteIndex)) cssClass = 'simple-other';
                else {
                    cssClass = 'free-note';
                    label = this.displayMode === 'note' ? label : '';
                }

                if (this.patternMode !== 'free' && !patternIntervals.includes(interval)) label = '';

                return { label: label, cssClass: cssClass, interval: interval };
            }

            renderCurrentPattern() {
                const data = this.generatePatternData();
                this.dom.patternInfoSpan.textContent = this.getPatternTitle();
                this.dom.fretboardDisplay.innerHTML = '';
                
                renderFretboardGrid(this.dom.fretboardDisplay, (stringIndex, fretIndex) => {
                    const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                    let hasNote = false;
                    
                    if (this.patternMode === 'free') {
                        if (this.selectedFreeNotes.has(noteIndex)) hasNote = true;
                    } else {
                        if (data.intervals.includes((noteIndex - data.rootIndex + 12) % 12)) hasNote = true;
                    }

                    if (hasNote) {
                        const { label, cssClass, interval } = this.getNoteLabelAndClass(noteIndex, data.intervals);
                        const dot = document.createElement('div');
                        
                        let finalClasses = `note-dot ${cssClass}`;
                        
                        // ìƒ‰ìƒ ëª¨ë“œ ë¡œì§ (Individual Mode ì ìš©)
                        if (this.colorMode === 'individual') {
                            if (interval === 0 && this.patternMode !== 'free') {
                                // Root ë…¸íŠ¸ëŠ” CSS í´ë˜ìŠ¤ ìŠ¤íƒ€ì¼(.root) ìœ ì§€ (ì§„í•œ ìƒ‰)
                            } else {
                                // ê·¸ ì™¸ ë…¸íŠ¸ëŠ” íŒŒìŠ¤í…” í†¤ ì ìš© ë° ê¸°ë³¸ CSS ì œê±°
                                dot.style.backgroundColor = fretboardNoteColors[noteIndex];
                                dot.style.color = 'black'; 
                                dot.style.border = 'none';
                                finalClasses = 'note-dot'; // Remove 'simple-other' class styling
                            }
                        }

                        dot.className = finalClasses;
                        dot.textContent = label;
                        return dot;
                    }
                    return null;
                });
            }

            handleFretClick(stringIndex, fretIndex) {
                const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                
                if (this.selectedFreeNotes.has(noteIndex)) this.selectedFreeNotes.delete(noteIndex);
                else this.selectedFreeNotes.add(noteIndex);

                this.dom.freeNoteButtonsContainer.querySelectorAll('.note-select-btn').forEach(btn => {
                    const btnNoteIndex = parseInt(btn.dataset.noteIndex);
                    if (this.selectedFreeNotes.has(btnNoteIndex)) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                this.renderCurrentPattern();
                fretboardUpdateCombinedView();
            }

            setupEventListeners() {
                const update = () => {
                    this.renderCurrentPattern();
                    fretboardUpdateCombinedView();
                };

                // Remove Button
                this.dom.removeBtn.addEventListener('click', () => {
                    this.dom.root.remove();
                    delete fretboardInstances[this.id];
                    fretboardRenumberInstances();
                    fretboardUpdateCombinedView();
                });

                // Color Mode Buttons
                this.dom.colorModeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.color-mode-btn');
                    if (!btn) return;
                    this.colorMode = btn.dataset.mode;
                    this.dom.colorModeButtons.querySelectorAll('.color-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    update();
                });

                // Mode Buttons
                this.dom.modeTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.mode-btn');
                    if (!btn) return;
                    this.patternMode = btn.dataset.mode;
                    this.dom.modeTypeButtons.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    this.dom.scaleControls.style.display = 'none';
                    this.dom.chordControls.style.display = 'none';
                    this.dom.freeNoteControls.style.display = 'none';
                    
                    if (this.patternMode === 'scale') this.dom.scaleControls.style.display = 'block';
                    else if (this.patternMode === 'chord') this.dom.chordControls.style.display = 'block';
                    else if (this.patternMode === 'free') {
                        this.dom.freeNoteControls.style.display = 'block';
                        this.renderFreeNoteButtons();
                    }
                    update();
                });

                // Display Mode Buttons
                this.dom.displayModeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.display-mode-btn');
                    if (!btn) return;
                    this.displayMode = btn.dataset.mode;
                    this.dom.displayModeButtons.querySelectorAll('.display-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.renderFreeNoteButtons(); 
                    update();
                });

                // Scale Type Buttons
                this.dom.scaleTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.scale-btn');
                    if (!btn) return;
                    this.scaleType = btn.dataset.scale;
                    this.dom.scaleTypeButtons.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    update();
                });

                // Chord Type Buttons
                this.dom.chordTypeButtons.addEventListener('click', (e) => {
                    const btn = e.target.closest('.chord-btn');
                    if (!btn) return;
                    this.chordType = btn.dataset.chord;
                    this.dom.chordTypeButtons.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    update();
                });

                // Root Note Buttons (Scale & Chord)
                [this.dom.scaleRootNoteButtons, this.dom.chordRootNoteButtons].forEach(container => {
                    container.addEventListener('click', (e) => {
                        const btn = e.target.closest('.root-btn');
                        if (!btn) return;
                        this.rootNote = btn.dataset.root;
                        
                        const targetRootButtons = this.patternMode === 'scale' ? this.dom.scaleRootNoteButtons : this.dom.chordRootNoteButtons;
                        targetRootButtons.querySelectorAll('.root-btn').forEach(b => {
                            if (b.dataset.root === this.rootNote) b.classList.add('active');
                            else b.classList.remove('active');
                        });
                        
                        this.renderFreeNoteButtons(); 
                        update();
                    });
                });

                // Free Note Buttons
                this.dom.freeNoteButtonsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('.note-select-btn');
                    if (!btn) return;
                    const noteIndex = parseInt(btn.dataset.noteIndex);
                    
                    if (this.selectedFreeNotes.has(noteIndex)) this.selectedFreeNotes.delete(noteIndex);
                    else this.selectedFreeNotes.add(noteIndex);
                    
                    btn.classList.toggle('active');
                    update();
                });
                
                // Clear Free Notes
                this.dom.clearFreeNotesBtn.addEventListener('click', () => {
                    this.selectedFreeNotes.clear();
                    this.dom.freeNoteButtonsContainer.querySelectorAll('.note-select-btn').forEach(btn => btn.classList.remove('active'));
                    update();
                });
                
                // Fretboard Click Listener for Free Note Mode
                this.dom.fretboardDisplay.addEventListener('click', (e) => {
                    if (this.patternMode !== 'free') return;
                    let target = e.target.closest('.fret-space');
                    if (!target) return;
                    
                    const parentRow = target.parentElement;
                    const rowIndex = Array.from(this.dom.fretboardDisplay.children).indexOf(parentRow);
                    if (rowIndex < 0) return; 

                    let numStringRows = fretboardOpenStrings.length; 
                    let stringRowIndex = rowIndex; 
                    
                    if (stringRowIndex < 0 || stringRowIndex >= numStringRows) return;
                    
                    const stringIndex = stringRowIndex;
                    const fretIndex = Array.from(parentRow.children).indexOf(target);
                    
                    this.handleFretClick(stringIndex, fretIndex);
                });
                
                this.dom.toggleCompactBtn.addEventListener('click', () => {
                    this.toggleCompactMode(!this.dom.root.classList.contains('compact-mode'));
                });
            }
        }
        
        function fretboardRenumberInstances() {
            const keys = Object.keys(fretboardInstances).map(Number).sort((a, b) => a - b);
            let newInstances = {};
            keys.forEach((oldId, index) => {
                const newId = index + 1;
                const instance = fretboardInstances[oldId];
                instance.id = newId;
                instance.dom.instanceTitle.textContent = `ğŸ¸ ì…ë ¥ ì§€íŒ #${newId}`;
                instance.rootElement.id = `fretboard-instance-${newId}`;
                newInstances[newId] = instance;
            });
            fretboardInstances = newInstances;
            fretboardNextId = keys.length + 1;
        }

        function fretboardUpdateCombinedView() {
            const ids = Object.keys(fretboardInstances).map(Number).sort((a, b) => a - b);
            const legendItemsContainer = document.getElementById('legend-items');

            if (ids.length === 0) {
                combinedResultSection.style.display = 'none';
                legendItemsContainer.innerHTML = '';
                return;
            }

            combinedResultSection.style.display = 'block';
            combinedResultDisplay.innerHTML = '';
            legendItemsContainer.innerHTML = '';

            // 1. ë²”ë¡€ ìƒì„± (Legend)
            ids.forEach((id, idx) => {
                const inst = fretboardInstances[id];
                const patternTitle = inst.getPatternTitle();
                const colorIndex = (idx % 5) + 1;
                const colorVar = `--color-p${colorIndex}`;

                const legendItem = document.createElement('span');
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.fontSize = '0.9em';
                legendItem.style.color = 'var(--text-main)';

                const colorDot = document.createElement('div');
                colorDot.style.width = '12px';
                colorDot.style.height = '12px';
                colorDot.style.borderRadius = '50%';
                colorDot.style.backgroundColor = `var(${colorVar})`;
                colorDot.style.marginRight = '8px';

                legendItem.appendChild(colorDot);
                legendItem.append(document.createTextNode(`${inst.dom.instanceTitle.textContent}: ${patternTitle}`));
                legendItemsContainer.appendChild(legendItem);
            });

            // 2. ì§€íŒ ë Œë”ë§ (Fretboard) - Gradient Style (index.html ë°©ì‹)
            renderFretboardGrid(combinedResultDisplay, (stringIndex, fretIndex) => {
                const noteIndex = (fretboardOpenStrings[stringIndex] + fretIndex) % 12;
                let activeSources = [];

                ids.forEach((id, idx) => {
                    const inst = fretboardInstances[id];
                    const data = inst.generatePatternData();
                    let hasNote = false;

                    if (data.patternType === 'free') {
                        if (data.selectedFreeNotes.has(noteIndex)) hasNote = true;
                    } else {
                        if (data.intervals.includes((noteIndex - data.rootIndex + 12) % 12)) hasNote = true;
                    }
                    
                    if (hasNote) {
                        activeSources.push({ 
                            id: id, 
                            idx: idx, 
                            data: data,
                            colorVar: `--color-p${(idx % 5) + 1}`,
                            label: inst.getNoteLabelAndClass(noteIndex, data.intervals).label
                        });
                    }
                });

                if (activeSources.length === 0) return null;

                const dotDiv = document.createElement('div');
                dotDiv.className = 'note-dot';
                dotDiv.textContent = activeSources[0].label;
                dotDiv.style.color = 'white';

                // Gradient Logic for Combined View
                if (activeSources.length === 1) {
                    dotDiv.style.backgroundColor = `var(${activeSources[0].colorVar})`;
                } else {
                    let gradientStops = [];
                    const count = activeSources.length;
                    
                    // ì†ŒìŠ¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (id ê¸°ì¤€)
                    activeSources.sort((a, b) => a.id - b.id);

                    activeSources.forEach((src, i) => {
                        const startPct = (i / count) * 100;
                        const endPct = ((i + 1) / count) * 100;
                        gradientStops.push(`var(${src.colorVar}) ${startPct}% ${endPct}%`);
                    });
                    
                    // Linear Gradient ì ìš© (index.html ìŠ¤íƒ€ì¼)
                    dotDiv.style.background = `linear-gradient(to right, ${gradientStops.join(', ')})`;
                    
                    // í…ìŠ¤íŠ¸ ê°€ë…ì„±ì„ ìœ„í•´ ê·¸ë¦¼ì ì¶”ê°€
                    dotDiv.style.textShadow = '0 0 2px black';
                }

                return dotDiv;
            });
        }

        function fretboardAddNewFretboard() {
            const newId = fretboardNextId++;
            const instance = new FretboardInstance(newId);
            fretboardCollection.appendChild(instance.rootElement);
            // ì´ˆê¸°ê°’ ì„¤ì •
            instance.dom.scaleRootNoteButtons.querySelector('[data-root="C"]').click();
            instance.dom.scaleTypeButtons.querySelector('[data-scale="Major"]').click();
            
            fretboardUpdateCombinedView(); 
            return instance;
        }

        fretboardAddFullBtn.addEventListener('click', () => fretboardAddNewFretboard());

        document.addEventListener('DOMContentLoaded', () => {
            rhythmUpdateTheme('blue', 'light'); 
            rhythmGenerateRhythm();
            rhythmDisplayPattern(rhythmPattern);
            rhythmSwingAmount = 0; 
            rhythmHandleSwingSelection(rhythmSwingAmount);
            rhythmMetronomeToggle.checked = rhythmIsMetronomeAlwaysOn;
        });

    </script>
</body>
</html>
